<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
<title>æ­¡æ¨‚å¤§å¯Œç¿ - ç©©å®šç‰ˆ v2.0</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>  
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:"Microsoft JhengHei",sans-serif;
  background:#111;
  height:100vh;overflow:hidden;
  display:flex;align-items:center;justify-content:center;
  padding-bottom:70px;
}
<!-- ğŸ” LINE ç™»å…¥ç•«é¢ -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="logo">ğŸ²</div>
    <h1>æ­¡æ¨‚å¤§å¯Œç¿</h1>
    <p>æ­¡è¿ä¾†åˆ°æ¿æ©‹å•†åœˆï¼<br>è«‹å…ˆä½¿ç”¨ LINE ç™»å…¥é–‹å§‹éŠæˆ²ï¼Œ<br>æ”¶é›†å°ˆå±¬å„ªæƒ åˆ¸å§ï¼</p>
    <button class="line-login-btn" onclick="startLineLogin()">
      <span class="icon">ğŸ“±</span>
      <span>ä½¿ç”¨ LINE ç™»å…¥</span>
    </button>
  </div>
</div>

<!-- ğŸ¯ æ£‹ç›¤å€ -->
<div class="board" id="board">
  <div class="player" id="player">
    <img src="https://aiwe.cc/wp-content/uploads/2025/11/897cb201ac922a1f9ed6e6f9082e84f5.png">
  </div>

  <div class="center">
    <div class="msg" id="msg"></div>
    <div class="dice-box">
      <div class="dice face-1" id="dice1"><div class="dot"></div></div>
      <div class="dice face-1" id="dice2"><div class="dot"></div></div>
    </div>
    <button class="roll-btn" onclick="startGame()" id="rollBtn">ğŸ² æŠ•æ“²éª°å­</button>
  </div>
</div>

<!-- ğŸ§§ åº—å®¶å„ªæƒ å¡ç‰‡ -->
<div class="shop-popup" id="shopPopup">
  <img id="shopImg" src="">
  <div class="shop-content">
    <h2 id="shopName"></h2>
    <p id="shopDesc"></p>
    <div class="shop-buttons">
      <button class="claim" id="claimBtn">æ”¶è—å„ªæƒ </button>
      <button class="close" onclick="closeShop()">æ”¾æ£„æ”¶è—</button>
    </div>
  </div>
</div>

<!-- ğŸ« å„ªæƒ åˆ¸æ”¶é›†å€ -->
<div class="coupon-panel" id="couponPanel">
  <div class="coupon-panel-header">
    <h2>æˆ‘çš„å„ªæƒ åˆ¸ (<span id="couponCount">0</span>)</h2>
    <button class="close-btn" onclick="closeCouponPanel()">Ã—</button>
  </div>
  <div class="coupon-list" id="couponList">
    <div class="empty-state">
      <div class="icon">ğŸ«</div>
      <p>é‚„æ²’æœ‰æ”¶é›†ä»»ä½•å„ªæƒ åˆ¸<br>å¿«å»éŠæˆ²ä¸­æ”¶é›†å§ï¼</p>
    </div>
  </div>
</div>

<!-- ğŸ—ºï¸ åº—å®¶åœ°åœ– -->
<div class="map-panel" id="mapPanel">
  <div class="map-panel-header">
    <h2>åº—å®¶åœ°åœ–</h2>
    <button class="close-btn" onclick="closeMapPanel()">Ã—</button>
  </div>
  <div class="map-container">
    <div class="shop-list" id="shopList">
      <p style="text-align:center;color:#999;padding:20px;">è¼‰å…¥ä¸­...</p>
    </div>
  </div>
</div>

<!-- ğŸ“± åº•éƒ¨åŠŸèƒ½åˆ— -->
<div class="bottom-bar">
  <button id="lineLoginBtn" onclick="lineLogin()">
    <span class="icon">ğŸ“±</span>
    <img class="line-avatar" id="lineAvatar" src="" alt="LINE">
    <span id="lineLoginText">LINE</span>
  </button>
  
  <button onclick="openCouponPanel()">
    <span class="icon">ğŸ«</span><span>å„ªæƒ åˆ¸</span>
  </button>
  
  <button onclick="openMapPanel()">
    <span class="icon">ğŸ—ºï¸</span><span>åº—å®¶åœ°åœ–</span>
  </button>
  
  <button onclick="switchToSVGVersion()">
    <span class="icon">ğŸ®</span><span>SVGç‰ˆæœ¬</span>
  </button>
</div>

<!-- ğŸµ éŸ³æ•ˆ -->
<audio id="bgm" loop src="https://aiwe.cc/wp-content/uploads/2025/11/901cd11beb7b52aea3f9011f2d3d33bb.mp3"></audio>
<audio id="sDice" src="https://aiwe.cc/wp-content/uploads/2025/11/77b2287cce9574aeb82a8dbbcf200050.mp3"></audio>
<audio id="sMove" src="https://aiwe.cc/wp-content/uploads/2025/11/f8bf2fa137503315a28ad81a8aee77a5.mp3"></audio>

<script>
// ğŸ® éŠæˆ²æ ¸å¿ƒè®Šæ•¸
const GAS_BASE = 'https://richman.fangwl591021.workers.dev/';
const player = document.getElementById('player');
const board = document.getElementById('board');
const msg = document.getElementById('msg');
const dice1 = document.getElementById('dice1');
const dice2 = document.getElementById('dice2');
const rollBtn = document.getElementById('rollBtn');
const bgm = document.getElementById('bgm');
const sDice = document.getElementById('sDice');
const sMove = document.getElementById('sMove');
const shopPopup = document.getElementById('shopPopup');
const shopImg = document.getElementById('shopImg');
const shopName = document.getElementById('shopName');
const shopDesc = document.getElementById('shopDesc');
const claimBtn = document.getElementById('claimBtn');
const loginScreen = document.getElementById('loginScreen');
const lineAvatar = document.getElementById('lineAvatar');
const lineLoginBtn = document.getElementById('lineLoginBtn');

let currentShop = null;
let userId = "TEMP_USER";
const rows = 9, cols = 6;
let pos = 0;

// å»ºç«‹è·¯å¾‘
const path = [];
for (let x = cols - 1; x >= 0; x--) path.push({ x, y: rows - 1 });
for (let y = rows - 2; y >= 0; y--) path.push({ x: 0, y });
for (let x = 1; x < cols; x++) path.push({ x, y: 0 });
for (let y = 1; y < rows - 1; y++) path.push({ x: cols - 1, y });

// ğŸ² é–‹å§‹éŠæˆ²
function startGame() {
  if (bgm.paused) {
    bgm.volume = 0.3;
    bgm.play().catch(()=>{});
  }
  rollDice();
}
function showMsg(t){ msg.textContent=t; msg.style.opacity=1; }
function hideMsg(){ msg.style.opacity=0; setTimeout(()=>msg.textContent="",500); }

function updatePlayer(){
  const cell=path[pos];
  const w=board.clientWidth/cols;
  const h=board.clientHeight/rows;
  player.style.left=`${cell.x*w+w/2-player.clientWidth/2}px`;
  player.style.top=`${cell.y*h+h/2-player.clientHeight/2}px`;
}
function updateDiceFace(el,v){
  el.className='dice face-'+v; el.innerHTML='';
  for(let i=0;i<v;i++){const dot=document.createElement('div');dot.className='dot';el.appendChild(dot);}
}
function rollDice(){
  rollBtn.disabled=true;
  sDice.currentTime=0; sDice.play();
  const v1=Math.floor(Math.random()*6)+1;
  const v2=Math.floor(Math.random()*6)+1;
  updateDiceFace(dice1,v1);
  updateDiceFace(dice2,v2);
  const steps=v1+v2;
  showMsg(`å‰é€² ${steps} æ ¼ï¼`);
  movePlayer(steps);
}

async function movePlayer(steps){
  for(let i=0;i<steps;i++){
    pos=(pos+1)%path.length;
    updatePlayer();
    sMove.currentTime=0; sMove.play();
    await new Promise(r=>setTimeout(r,400));
  }
  checkEvent();
}

async function checkEvent(){
  showMsg("æª¢æŸ¥åº—å®¶ä¸­...");
  try{
    const res=await fetch(`${GAS_BASE}?action=getShops`);
    const json=await res.json();
    if(json.success && json.data.length>0){
      const shop=json.data[Math.floor(Math.random()*json.data.length)];
      showShopPopup(shop);
    }else{
      showMsg("æ²’æœ‰å¯é¡¯ç¤ºçš„åº—å®¶ã€‚");
    }
  }catch(err){
    console.error("âŒ è¼‰å…¥åº—å®¶è³‡æ–™éŒ¯èª¤:",err);
    showMsg("è³‡æ–™è¼‰å…¥å¤±æ•—ã€‚");
  }finally{
    rollBtn.disabled=false;
  }
}

function showShopPopup(shop){
  currentShop=shop;
  shopImg.src=(shop["åœ–ç‰‡ç¶²å€"]&&shop["åœ–ç‰‡ç¶²å€"].startsWith("http"))?shop["åœ–ç‰‡ç¶²å€"]:"https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg";
  shopName.textContent=shop["åº—å®¶åç¨±"]||"æœªçŸ¥åº—å®¶";
  shopDesc.innerHTML=(shop["å„ªæƒ å…§å®¹"]||"å„ªæƒ å…§å®¹ä¸æ˜").replace(/\\n/g,"<br>");
  shopPopup.classList.add("active");
  claimBtn.onclick=()=>saveCoupon(shop);
}
function closeShop(){
  shopPopup.classList.remove("active");
  showMsg("ç¹¼çºŒéŠæˆ²å§ï¼");
}

async function saveCoupon(shop){
  try{
    const res=await fetch(`${GAS_BASE}`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        action:"saveCoupon",
        userId:userId,
        shopId:shop["ID"]||"",
        shopName:shop["åº—å®¶åç¨±"],
        discount:shop["å„ªæƒ å…§å®¹"],
        imageUrl:shop["åœ–ç‰‡ç¶²å€"]
      })
    });
    const json=await res.json();
    if(json.success){ alert("ğŸ‰ å„ªæƒ åˆ¸å·²æ”¶è—ï¼"); closeShop(); }
    else alert("âŒ æ”¶è—å¤±æ•—ï¼š" + json.message);
  }catch(err){
    alert("âš ï¸ å„²å­˜éŒ¯èª¤ï¼š" + err);
  }
}

/* === å„ªæƒ åˆ¸é¢æ¿ === */
async function openCouponPanel(){
  const panel=document.getElementById('couponPanel');
  const list=document.getElementById('couponList');
  const count=document.getElementById('couponCount');
  list.innerHTML='<p style="color:#999;text-align:center;padding:20px;">è¼‰å…¥ä¸­...</p>';
  panel.classList.add('active');
  try{
    const res=await fetch(`${GAS_BASE}?action=getUserCoupons&userId=${userId}`);
    const json=await res.json();
    if(json.success && json.coupons.length>0){
      list.innerHTML='';
      json.coupons.forEach(c=>{
        const div=document.createElement('div');
        div.className='coupon-item';
        div.innerHTML=`<img src="${c.imageUrl}" alt=""><div><h3>${c.shopName}</h3><p>${c.discount}</p></div>`;
        list.appendChild(div);
      });
      count.textContent=json.coupons.length;
    }else{
      list.innerHTML='<div class="empty-state"><div class="icon">ğŸ«</div><p>ç›®å‰æ²’æœ‰å„ªæƒ åˆ¸</p></div>';
      count.textContent=0;
    }
  }catch(err){
    list.innerHTML='<p style="color:red;text-align:center;">è®€å–å¤±æ•—</p>';
  }
}
function closeCouponPanel(){
  document.getElementById('couponPanel').classList.remove('active');
}

/* === åº—å®¶åœ°åœ– === */
async function openMapPanel(){
  const panel=document.getElementById('mapPanel');
  const list=document.getElementById('shopList');
  list.innerHTML='<p style="color:#999;text-align:center;padding:20px;">è¼‰å…¥ä¸­...</p>';
  panel.classList.add('active');
  try{
    const res=await fetch(`${GAS_BASE}?action=getShops`);
    const json=await res.json();
    if(json.success && json.data.length>0){
      list.innerHTML='';
      json.data.forEach(s=>{
        const div=document.createElement('div');
        div.className='shop-card';
        div.innerHTML=`<img src="${s["åœ–ç‰‡ç¶²å€"]}" alt=""><div><h3>${s["åº—å®¶åç¨±"]}</h3><p>${s["å„ªæƒ å…§å®¹"].replace(/\\n/g,"<br>")}</p></div>`;
        list.appendChild(div);
      });
    }else list.innerHTML='<p style="color:#999;text-align:center;padding:20px;">ç›®å‰ç„¡åº—å®¶è³‡æ–™</p>';
  }catch(err){
    list.innerHTML='<p style="color:red;text-align:center;">åœ°åœ–è¼‰å…¥éŒ¯èª¤</p>';
  }
}
function closeMapPanel(){
  document.getElementById('mapPanel').classList.remove('active');
}

/* === LINE ç™»å…¥ === */
async function startLineLogin(){
  try{
    await liff.init({ liffId: "2008231249-7DlMkygo" });
    if(!liff.isLoggedIn()) liff.login();
    const profile=await liff.getProfile();
    userId=profile.userId;
    lineAvatar.src=profile.pictureUrl;
    document.getElementById('lineLoginText').textContent=profile.displayName;
    loginScreen.classList.add('hidden');
    await saveUser(profile);
    updatePlayer();
  }catch(err){
    console.error("LINE ç™»å…¥å¤±æ•—:",err);
    alert("LINE ç™»å…¥å¤±æ•—ï¼š" + err);
  }
}

async function saveUser(profile){
  try{
    await fetch(GAS_BASE,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        action:'saveUser',
        userId:profile.userId,
        displayName:profile.displayName,
        pictureUrl:profile.pictureUrl,
        statusMessage:profile.statusMessage||''
      })
    });
  }catch(e){ console.warn('ç”¨æˆ¶è³‡æ–™å„²å­˜å¤±æ•—:',e); }
}

/* === åˆå§‹åŒ– === */
window.onload=()=>{
  updatePlayer();
  showMsg("è«‹ç™»å…¥ LINE é–‹å§‹éŠæˆ²ï¼");
};
</script>
</body>
</html>

/* === LINE ç™»å…¥ç•«é¢ === */
.login-screen{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:999;padding:20px;
}
.login-screen.hidden{display:none;}
.login-box{
  background:white;border-radius:30px;
  padding:50px 40px;text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.3);
  max-width:450px;width:100%;
  animation:slideIn 0.5s ease;
}
@keyframes slideIn{
  from{opacity:0;transform:translateY(-30px);}
  to{opacity:1;transform:translateY(0);}
}
.login-box .logo{font-size:80px;margin-bottom:20px;animation:bounce 1s infinite ease-in-out;}
@keyframes bounce{0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);}}
.login-box h1{font-size:36px;color:#333;margin-bottom:15px;}
.login-box p{font-size:18px;color:#666;margin-bottom:40px;line-height:1.6;}
.login-box .line-login-btn{
  width:100%;padding:20px;background:#06C755;color:white;border:none;
  border-radius:15px;font-size:24px;font-weight:bold;cursor:pointer;
  transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;
  gap:15px;box-shadow:0 8px 20px rgba(6,199,85,0.3);
}
.login-box .line-login-btn:hover{
  background:#05b04b;transform:translateY(-2px);
  box-shadow:0 12px 30px rgba(6,199,85,0.4);
}

/* === æ£‹ç›¤èˆ‡ç©å®¶ === */
.board{
  position:fixed;top:50%;left:50%;
  transform:translate(-50%,-50%) translateY(-35px);
  width:95%;aspect-ratio:2/3;
  background:url("https://aiwe.cc/wp-content/uploads/2025/11/c4ca4238a0b923820dcc509a6f75849b-2.png") center/contain no-repeat;
  background-color:#000;border-radius:10px;overflow:hidden;
}
.player{position:absolute;width:80px;height:85px;transition:all .4s ease-in-out;z-index:10;}
.player img{width:100%;height:100%;object-fit:contain;}
@keyframes walk{0%,100%{transform:rotate(0);}25%{transform:rotate(-4deg);}75%{transform:rotate(4deg);}}
.walking{animation:walk .45s infinite ease-in-out;}

.center{
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);
  display:flex;flex-direction:column;align-items:center;gap:25px;
  z-index:5;
}
.msg{
  color:#000;font-size:20px;font-weight:bold;
  text-shadow:1px 1px 2px rgba(255,255,255,.6);
  margin-bottom:5px;min-height:24px;transition:opacity .5s ease;
}

/* === éª°å­æ¨£å¼ (2Dç©©å®šç‰ˆ) === */
.dice-box{display:flex;gap:25px;}
.dice{
  width:60px;height:60px;background:white;border-radius:12px;
  box-shadow:0 5px 15px rgba(0,0,0,.3);
  position:relative;display:flex;justify-content:center;align-items:center;
  border:2px solid #333;
}
.dot{width:10px;height:10px;background:black;border-radius:50%;position:absolute;}
.face-1 .dot:nth-child(1){top:50%;left:50%;transform:translate(-50%,-50%);}
.face-2 .dot:nth-child(1){top:20%;left:20%;}
.face-2 .dot:nth-child(2){bottom:20%;right:20%;}
.face-3 .dot:nth-child(1){top:20%;left:20%;}
.face-3 .dot:nth-child(2){top:50%;left:50%;transform:translate(-50%,-50%);}
.face-3 .dot:nth-child(3){bottom:20%;right:20%;}
.face-4 .dot:nth-child(1){top:20%;left:20%;}
.face-4 .dot:nth-child(2){top:20%;right:20%;}
.face-4 .dot:nth-child(3){bottom:20%;left:20%;}
.face-4 .dot:nth-child(4){bottom:20%;right:20%;}
.face-5 .dot:nth-child(1){top:20%;left:20%;}
.face-5 .dot:nth-child(2){top:20%;right:20%;}
.face-5 .dot:nth-child(3){top:50%;left:50%;transform:translate(-50%,-50%);}
.face-5 .dot:nth-child(4){bottom:20%;left:20%;}
.face-5 .dot:nth-child(5){bottom:20%;right:20%;}
.face-6 .dot:nth-child(1){top:20%;left:20%;}
.face-6 .dot:nth-child(2){top:20%;right:20%;}
.face-6 .dot:nth-child(3){top:50%;left:20%;transform:translateY(-50%);}
.face-6 .dot:nth-child(4){top:50%;right:20%;transform:translateY(-50%);}
.face-6 .dot:nth-child(5){bottom:20%;left:20%;}
.face-6 .dot:nth-child(6){bottom:20%;right:20%;}

/* === æŒ‰éˆ•æ¨£å¼ === */
.roll-btn{
  padding:15px 30px;background:linear-gradient(135deg,#667eea,#764ba2);
  color:white;font-size:20px;font-weight:bold;border:none;
  border-radius:25px;box-shadow:0 4px 10px rgba(0,0,0,.3);
  cursor:pointer;transition:all 0.3s ease;
}
.roll-btn:hover:not(:disabled){
  transform:translateY(-2px);
  box-shadow:0 6px 15px rgba(0,0,0,.4);
}
.roll-btn:disabled{opacity:0.6;cursor:not-allowed;}

/* === åº—å®¶å½ˆçª—ã€å„ªæƒ åˆ¸ã€åœ°åœ–ç¸®å°ä¸‰åˆ†ä¹‹ä¸€ === */
.shop-popup, .coupon-panel, .map-panel{
  transform-origin:center;
  scale:0.67;
}

/* === é ­åƒèˆ‡åº•éƒ¨é¸å–® === */
.bottom-bar{
  position:fixed;bottom:0;left:0;right:0;
  height:60px;background:rgba(0,0,0,0.85);
  display:flex;justify-content:space-around;align-items:center;
  z-index:100;backdrop-filter:blur(10px);
  border-top:2px solid rgba(255,255,255,0.1);
}
.bottom-bar button{
  flex:1;height:100%;border:none;
  background:transparent;color:white;
  font-size:12px;font-weight:bold;
  cursor:pointer;transition:all .3s ease;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;
}
.bottom-bar button:active{background:rgba(255,255,255,0.1);}
.bottom-bar button .icon{font-size:24px;}
.line-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid #fff;}
</style>
</head>
<body>
