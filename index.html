<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
<title>æ­¡æ¨‚å¤§å¯Œç¿</title>
<style>
/* ä¿æŒæ‚¨åŸæœ‰çš„æ‰€æœ‰ CSS æ¨£å¼ä¸è®Š */
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:"Microsoft JhengHei",sans-serif;
  background:#111;
  height:100vh;overflow:hidden;
  display:flex;align-items:center;justify-content:center;
  padding-bottom:70px;
}

/* ä¿æŒæ‚¨åŸæœ‰çš„æ‰€æœ‰å…¶ä»– CSS æ¨£å¼... */
.board{/* ä¿æŒä¸è®Š */}
.player{/* ä¿æŒä¸è®Š */}
.center{/* ä¿æŒä¸è®Š */}
.msg{/* ä¿æŒä¸è®Š */}
.dice-box{/* ä¿æŒä¸è®Š */}
.dice{/* ä¿æŒä¸è®Š */}
.dot{/* ä¿æŒä¸è®Š */}
.roll-btn{/* ä¿æŒä¸è®Š */}
.shop-popup{/* ä¿æŒä¸è®Š */}
.shop-content{/* ä¿æŒä¸è®Š */}
.shop-buttons{/* ä¿æŒä¸è®Š */}
.bottom-bar{/* ä¿æŒä¸è®Š */}
.coupon-panel{/* ä¿æŒä¸è®Š */}
.map-panel{/* ä¿æŒä¸è®Š */}
/* ... è¤‡è£½æ‚¨åŸæœ‰çš„æ‰€æœ‰éŠæˆ² CSS ... */
</style>
</head>
<body>

<!-- âŒ ç§»é™¤ç™»å…¥ç•«é¢ï¼Œæ”¹ç”± login.html è™•ç† -->

<!-- éŠæˆ²ä¸»ç•«é¢ -->
<div class="board" id="board">
  <div class="player" id="player">
    <img src="https://aiwe.cc/wp-content/uploads/2025/11/897cb201ac922a1f9ed6e6f9082e84f5.png">
  </div>

  <div class="center">
    <div class="msg" id="msg"></div>
    <div class="dice-box">
      <div class="dice face-1" id="dice1"><div class="dot"></div></div>
      <div class="dice face-1" id="dice2"><div class="dot"></div></div>
    </div>
    <button class="roll-btn" onclick="startGame()" id="rollBtn">æŠ•æ“²éª°å­</button>
  </div>
</div>

<!-- ... ä¿æŒæ‚¨åŸæœ‰çš„æ‰€æœ‰å…¶ä»– HTML ... -->

<script>
// ============================================
// ğŸ® éŠæˆ²æ ¸å¿ƒè¨­å®š
// ============================================
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwwO2pMBDAADUEZ8NKYbicrB3_LlcL2u3-bZZF5xXjrgBxNlHLbXXLT_N7uorJgYhPB/exec';

const player = document.getElementById('player');
const board = document.getElementById('board');
const msg = document.getElementById('msg');
const dice1 = document.getElementById('dice1');
const dice2 = document.getElementById('dice2');
const rollBtn = document.getElementById('rollBtn');
const bgm = document.getElementById('bgm');
const sDice = document.getElementById('sDice');
const sMove = document.getElementById('sMove');
const shopPopup = document.getElementById('shopPopup');
const shopImg = document.getElementById('shopImg');
const shopName = document.getElementById('shopName');
const shopDesc = document.getElementById('shopDesc');
const claimBtn = document.getElementById('claimBtn');

let currentShop = null;
const rows = 9, cols = 6;
let pos = 0;
let userId = "TEMP_USER";
let userDisplayName = "è¨ªå®¢";

// éŠæˆ²è·¯å¾‘è¨­å®šï¼ˆä¿æŒä¸è®Šï¼‰
const path = [];
for (let x = cols - 1; x >= 0; x--) path.push({ x, y: rows - 1 });
for (let y = rows - 2; y >= 0; y--) path.push({ x: 0, y });
for (let x = 1; x < cols; x++) path.push({ x, y: 0 });
for (let y = 1; y < rows - 1; y++) path.push({ x: cols - 1, y });

// ============================================
// âœ… ç°¡åŒ–çš„ç™»å…¥æª¢æŸ¥ï¼ˆåªæª¢æŸ¥ localStorageï¼‰
// ============================================
function checkLogin() {
  const storedUserId = localStorage.getItem('lineUserId');
  const storedDisplayName = localStorage.getItem('lineDisplayName');
  
  if (!storedUserId) {
    // æœªç™»å…¥ï¼Œè·³è½‰åˆ°ç™»å…¥é é¢
    console.log('âŒ æœªç™»å…¥ï¼Œè·³è½‰åˆ° login.html');
    window.location.href = 'login.html';
    return false;
  }
  
  // å·²ç™»å…¥
  userId = storedUserId;
  userDisplayName = storedDisplayName || 'å·²ç™»å…¥ç”¨æˆ¶';
  console.log('âœ… å·²ç™»å…¥:', userDisplayName);
  
  // æ›´æ–°åº•éƒ¨æŒ‰éˆ•é¡¯ç¤º
  const lineLoginText = document.getElementById('lineLoginText');
  if (lineLoginText) {
    lineLoginText.textContent = userDisplayName;
  }
  
  return true;
}

// åº•éƒ¨åŠŸèƒ½åˆ—çš„ç™»å‡ºæŒ‰éˆ•
async function lineLogin() {
  if (localStorage.getItem('lineUserId')) {
    // å·²ç™»å…¥ï¼Œé¡¯ç¤ºç™»å‡ºé¸é …
    if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
      localStorage.clear();
      window.location.href = 'login.html';
    }
  } else {
    // æœªç™»å…¥ï¼Œè·³è½‰åˆ°ç™»å…¥é é¢
    window.location.href = 'login.html';
  }
}

// ============================================
// ğŸ® éŠæˆ²æ ¸å¿ƒåŠŸèƒ½ï¼ˆä¿æŒæ‚¨åŸæœ‰çš„æ‰€æœ‰ç¨‹å¼ç¢¼ï¼‰
// ============================================
function startGame() {
  if (bgm.paused) {
    bgm.volume = 0.3;
    bgm.play().catch(() => {});
  }
  rollDice();
}

function showMsg(t) {
  msg.textContent = t;
  msg.style.opacity = 1;
}

function hideMsg() {
  msg.style.opacity = 0;
  setTimeout(() => msg.textContent = "", 500);
}

function updatePlayer() {
  const cell = path[pos];
  const w = board.clientWidth / cols;
  const h = board.clientHeight / rows;
  let offsetX = 0;
  
  if (cell.y === rows - 1) offsetX = -w * 0.05;
  else if (cell.y === 0) offsetX = w * 0.05;
  
  if (cell.x === cols - 1 && cell.y > 0 && cell.y < rows - 1) offsetX -= w * 0.27;
  
  player.style.left = `${cell.x * w + w / 2 - player.clientWidth / 2 + offsetX}px`;
  player.style.top = `${cell.y * h + h / 2 - player.clientHeight / 2}px`;
}

function updateDiceFace(el, v) {
  el.className = 'dice face-' + v;
  el.innerHTML = '';
  for (let i = 0; i < v; i++) {
    const dot = document.createElement('div');
    dot.className = 'dot';
    el.appendChild(dot);
  }
}

async function rollDice() {
  rollBtn.disabled = true;
  sDice.currentTime = 0;
  sDice.play();
  
  let count = 0, v1 = 1, v2 = 1;
  const interval = setInterval(() => {
    v1 = Math.floor(Math.random() * 6) + 1;
    v2 = Math.floor(Math.random() * 6) + 1;
    updateDiceFace(dice1, v1);
    updateDiceFace(dice2, v2);
    count++;
    
    if (count > 15) {
      clearInterval(interval);
      sDice.pause();
      const total = v1 + v2;
      showMsg(`å‰é€² ${total} æ­¥ï¼`);
      movePlayer(total);
    }
  }, 80);
}

async function movePlayer(steps) {
  player.classList.add('walking');
  sMove.loop = true;
  sMove.currentTime = 0;
  sMove.play().catch(() => {});
  
  for (let i = 0; i < steps; i++) {
    pos = (pos + 1) % path.length;
    updatePlayer();
    await new Promise(r => setTimeout(r, 450));
  }
  
  player.classList.remove('walking');
  sMove.pause();
  sMove.currentTime = 0;
  
  await checkEvent();
  setTimeout(() => hideMsg(), 800);
  rollBtn.disabled = false;
}

// ============================================
// ğŸª åº—å®¶èˆ‡å„ªæƒ åŠŸèƒ½ï¼ˆä¿æŒä¸è®Šï¼‰
// ============================================
async function checkEvent() {
  const cell = path[pos];
  
  // æ‡²ç½°æ ¼é‚è¼¯
  if (cell.x === 0 && cell.y === 0) {
    showMsg("è¸©åˆ°æ‡²ç½°æ ¼ï¼é€€å›7æ­¥ï¼");
    for (let i = 0; i < 7; i++) {
      pos = (pos - 1 + path.length) % path.length;
      updatePlayer();
      await new Promise(r => setTimeout(r, 300));
    }
    return;
  }
  
  // è¼‰å…¥åº—å®¶è³‡æ–™
  try {
    const shops = await loadShops();
    if (shops.length > 0) {
      const shop = shops[Math.floor(Math.random() * shops.length)];
      currentShop = shop;
      showShopPopup(shop);
    }
  } catch (error) {
    console.error('è¼‰å…¥åº—å®¶æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
  }
}

function showShopPopup(shop) {
  const imgUrl = shop["åœ–ç‰‡ç¶²å€"] || shop.icon || shop["åœ–ç¤º"] || "";
  
  if (imgUrl && (imgUrl.startsWith("http://") || imgUrl.startsWith("https://"))) {
    shopImg.src = imgUrl;
    shopImg.onerror = function() {
      this.src = "https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg";
    };
  } else {
    shopImg.src = "https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg";
  }
  
  shopName.textContent = shop["åº—å®¶åç¨±"] || shop.name || "ç¥ç§˜åº—å®¶";
  shopDesc.textContent = shop["å„ªæƒ å…§å®¹"] || shop.discount || "é™æ™‚å„ªæƒ ï¼Œè¶•å¿«ä¾†çœ‹çœ‹ï¼";
  shopPopup.style.display = 'block';
  claimBtn.disabled = false;
  claimBtn.textContent = "æ”¶è—å„ªæƒ ";
}

function closeShop() {
  shopPopup.style.display = 'none';
}

// ============================================
// ğŸ« å„ªæƒ åˆ¸æ”¶é›†å€åŠŸèƒ½ï¼ˆä¿æŒä¸è®Šï¼‰
// ============================================
function openCouponPanel() {
  document.getElementById('couponPanel').classList.add('show');
  loadCoupons();
}

function closeCouponPanel() {
  document.getElementById('couponPanel').classList.remove('show');
}

async function loadCoupons() {
  const couponList = document.getElementById('couponList');
  const couponCount = document.getElementById('couponCount');
  
  try {
    const params = new URLSearchParams({
      action: 'getCoupons',
      userId: userId,
      sheetName: '2025/11'
    });
    
    const response = await safeFetch(`${GAS_URL}?${params}`);
    
    if (response.success && response.data && response.data.length > 0) {
      couponCount.textContent = response.data.length;
      
      couponList.innerHTML = response.data.map(coupon => `
        <div class="coupon-card">
          <img src="${coupon.imageUrl || 'https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg'}" 
               onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg'">
          <div class="coupon-card-info">
            <h3>${coupon.shopName || 'åº—å®¶åç¨±'}</h3>
            <p class="discount">${coupon.discount || 'å„ªæƒ å…§å®¹'}</p>
            <p style="font-size:14px;color:#999;margin-top:4px;">${coupon.createTime ? new Date(coupon.createTime).toLocaleDateString() : ''}</p>
          </div>
        </div>
      `).join('');
    } else {
      couponCount.textContent = '0';
      couponList.innerHTML = `
        <div class="empty-state">
          <div class="icon">ğŸ«</div>
          <p>é‚„æ²’æœ‰æ”¶é›†ä»»ä½•å„ªæƒ åˆ¸<br>å¿«å»éŠæˆ²ä¸­æ”¶é›†å§ï¼</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('âŒ è¼‰å…¥å„ªæƒ åˆ¸å¤±æ•—:', error);
    couponList.innerHTML = `
      <div class="empty-state">
        <div class="icon">âš ï¸</div>
        <p>è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>
      </div>
    `;
  }
}

// ============================================
// ğŸ—ºï¸ åº—å®¶åœ°åœ–åŠŸèƒ½ï¼ˆä¿æŒä¸è®Šï¼‰
// ============================================
function openMapPanel() {
  document.getElementById('mapPanel').classList.add('show');
  loadShopMap();
}

function closeMapPanel() {
  document.getElementById('mapPanel').classList.remove('show');
}

async function loadShopMap() {
  const shopList = document.getElementById('shopList');
  
  try {
    const shops = await loadShops();
    
    if (shops.length > 0) {
      shopList.innerHTML = shops.map(shop => `
        <div class="shop-item">
          <img src="${shop['åœ–ç‰‡ç¶²å€'] || 'https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg'}"
               onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg'">
          <div class="shop-item-info">
            <h3>${shop['åº—å®¶åç¨±'] || 'åº—å®¶åç¨±'}</h3>
            <p>${shop['å„ªæƒ å…§å®¹'] || 'å„ªæƒ å…§å®¹'}</p>
            <p class="address">ğŸ“ ${shop['åœ°å€'] || 'åœ°å€æœªæä¾›'}</p>
          </div>
        </div>
      `).join('');
    } else {
      shopList.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">æ²’æœ‰åº—å®¶è³‡æ–™</p>';
    }
  } catch (error) {
    console.error('âŒ è¼‰å…¥åº—å®¶åœ°åœ–å¤±æ•—:', error);
    shopList.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
  }
}

// ============================================
// ğŸ”§ å·¥å…·å‡½æ•¸ï¼ˆä¿æŒä¸è®Šï¼‰
// ============================================
async function safeFetch(url, options = {}) {
  try {
    const response = await fetch(url, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error('è«‹æ±‚å¤±æ•—:', error);
    return { success: false, message: error.message };
  }
}

async function loadShops() {
  const result = await safeFetch(`${GAS_URL}?action=getShops&sheet=åº—å®¶è³‡æ–™`);
  if (result.success && Array.isArray(result.data)) {
    return result.data;
  } else {
    console.error('è¼‰å…¥åº—å®¶è³‡æ–™å¤±æ•—:', result.message);
    return [];
  }
}

// ============================================
// ğŸ¯ äº‹ä»¶ç›£è½å™¨ï¼ˆä¿æŒä¸è®Šï¼‰
// ============================================
claimBtn.addEventListener('click', () => {
  if (!currentShop) return;
  
  claimBtn.disabled = true;
  claimBtn.textContent = "ğŸ‰ æ”¶è—ä¸­...";
  
  const shopId = currentShop.ID || '';
  const shopName = currentShop["åº—å®¶åç¨±"] || currentShop.name || '';
  const discount = currentShop["å„ªæƒ å…§å®¹"] || currentShop.discount || '';
  const category = currentShop["åˆ†é¡"] || currentShop.category || "ä¸€èˆ¬";
  const icon = currentShop.icon || currentShop["åœ–ç¤º"] || "ğŸª";
  const imageUrl = currentShop["åœ–ç‰‡ç¶²å€"] || currentShop.icon || '';
  
  const params = new URLSearchParams({
    action: "saveCoupon",
    userId: userId,
    couponId: 'CPN' + Date.now(),
    shopId: encodeURIComponent(shopId),
    shopName: encodeURIComponent(shopName),
    discount: encodeURIComponent(discount),
    category: encodeURIComponent(category),
    icon: encodeURIComponent(icon),
    imageUrl: encodeURIComponent(imageUrl),
    status: "active",
    sheetName: "2025/11"
  });
  
  fetch(`${GAS_URL}?${params.toString()}`)
    .then(r => r.json())
    .then(res => {
      if (res.success) {
        claimBtn.textContent = "âœ… æ”¶è—æˆåŠŸï¼";
        setTimeout(() => closeShop(), 1500);
      } else {
        claimBtn.textContent = "âš ï¸ æ”¶è—å¤±æ•—";
      }
    })
    .catch(err => {
      claimBtn.textContent = "âš ï¸ ç¶²è·¯éŒ¯èª¤";
    });
});

// ============================================
// âœ… é é¢è¼‰å…¥æ™‚åªæª¢æŸ¥ç™»å…¥ç‹€æ…‹
// ============================================
window.addEventListener('DOMContentLoaded', function() {
  console.log('=== ğŸ“± æª¢æŸ¥ç™»å…¥ç‹€æ…‹ ===');
  
  // æª¢æŸ¥ç™»å…¥
  if (!checkLogin()) {
    // æœƒè‡ªå‹•è·³è½‰åˆ° login.html
    return;
  }
  
  // å·²ç™»å…¥ï¼Œé¡¯ç¤ºæ­¡è¿è¨Šæ¯
  setTimeout(() => {
    showMsg(`æ­¡è¿ï¼Œ${userDisplayName}ï¼`);
    setTimeout(() => hideMsg(), 2000);
  }, 500);
  
  // åˆå§‹åŒ–è§’è‰²ä½ç½®
  updatePlayer();
});
</script>
</body>
</html>
