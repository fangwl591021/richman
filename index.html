<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
<title>æ­¡æ¨‚å¤§å¯Œç¿</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="common.js?v=2.0"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:"Microsoft JhengHei",sans-serif;
  background:#111;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:15px 0 75px;
  gap:15px;
}

/* éŠæˆ²æ¿ */
.board{
  width:95%;
  aspect-ratio:2/3;
  background:url("https://aiwe.cc/wp-content/uploads/2025/11/ece235adf24ce45191df6e0c0ba86e5.gif") center/contain no-repeat;
  background-color:#000;
  border-radius:10px;
  position:relative;
  overflow:hidden;
}

/* ç©å®¶ */
.player{
  position:absolute;
  width:80px;
  height:85px;
  transition:all .4s ease-in-out;
  z-index:10;
}
.player img{width:100%;height:100%;object-fit:contain;}
@keyframes walk{0%,100%{transform:rotate(0);}25%{transform:rotate(-4deg);}75%{transform:rotate(4deg);}}
.walking{animation:walk .45s infinite ease-in-out;}

/* ä¸­å¤®æ§åˆ¶å€ */
.center{
  position:absolute;
  top:65%;
  left:50%;
  transform:translate(-50%,-50%);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:15px;
  z-index:5;
}

.dice-box{
  display:flex;
  gap:25px;
}

.roll-btn{
  padding:15px 30px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:white;
  font-size:20px;
  font-weight:bold;
  border:none;
  border-radius:25px;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
  cursor:pointer;
  transition:all 0.3s ease;
}

.msg{
  color:#000;
  font-size:14px;
  font-weight:bold;
  text-shadow:1px 1px 2px rgba(255,255,255,.6);
  min-height:18px;
  transition:opacity .5s ease;
}

/* ========== 3D éª°å­æ¨£å¼ ========== */
/* 3D å ´æ™¯å®¹å™¨ */
.dice-scene {
  width: 52px;
  height: 52px;
  perspective: 600px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* 3D éª°å­å®¹å™¨ */
.dice {
  width: 52px;
  height: 52px;
  position: relative;
  transform-style: preserve-3d;
  /* ğŸ¯ é—œéµä¿®æ­£ï¼šç§»é™¤ transitionï¼Œé¿å…èˆ‡å‹•ç•«è¡çª */
  transform: rotateX(0deg) rotateY(0deg);
}

/* éª°å­çš„æ¯ä¸€é¢ */
.dice-face {
  width: 52px;
  height: 52px;
  background: linear-gradient(145deg, #ffffff, #f0f0f0);
  border-radius: 8px;
  position: absolute;
  box-shadow: 
    inset 0 0 10px rgba(0,0,0,0.1),
    0 2px 8px rgba(0,0,0,0.15);
}

/* éª°å­é»æ•¸ */
.dot {
  width: 8px;
  height: 8px;
  background: #333;
  border-radius: 50%;
  position: absolute;
  box-shadow: inset 0 2px 3px rgba(0,0,0,0.3);
}

/* 6å€‹é¢çš„3Dä½ç½® */
.dice-face.front  { transform: rotateY(0deg)   translateZ(26px); }
.dice-face.back   { transform: rotateY(180deg) translateZ(26px); }
.dice-face.right  { transform: rotateY(90deg)  translateZ(26px); }
.dice-face.left   { transform: rotateY(-90deg) translateZ(26px); }
.dice-face.top    { transform: rotateX(90deg)  translateZ(26px); }
.dice-face.bottom { transform: rotateX(-90deg) translateZ(26px); }

/* 1é» - ä¸­å¤®ç´…è‰² */
.face-1 .dot {
  background: #d32f2f;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

/* 2é» - å°è§’ç·š */
.face-2 .dot:nth-child(1) {
  top: 25%;
  left: 25%;
}
.face-2 .dot:nth-child(2) {
  bottom: 25%;
  right: 25%;
}

/* 3é» - æ­£ä¸‰è§’å°è§’ç·š */
.face-3 .dot:nth-child(1) {
  top: 25%;
  left: 25%;
}
.face-3 .dot:nth-child(2) {
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
.face-3 .dot:nth-child(3) {
  bottom: 25%;
  right: 25%;
}

/* 4é» - å››å€‹è§’è½ */
.face-4 .dot:nth-child(1) {
  top: 25%;
  left: 25%;
}
.face-4 .dot:nth-child(2) {
  top: 25%;
  right: 25%;
}
.face-4 .dot:nth-child(3) {
  bottom: 25%;
  left: 25%;
}
.face-4 .dot:nth-child(4) {
  bottom: 25%;
  right: 25%;
}

/* 5é» - å››è§’+ä¸­å¤® */
.face-5 .dot:nth-child(1) {
  top: 25%;
  left: 25%;
}
.face-5 .dot:nth-child(2) {
  top: 25%;
  right: 25%;
}
.face-5 .dot:nth-child(3) {
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
.face-5 .dot:nth-child(4) {
  bottom: 25%;
  left: 25%;
}
.face-5 .dot:nth-child(5) {
  bottom: 25%;
  right: 25%;
}

/* 6é» - å·¦å³å…©åˆ— */
.face-6 .dot:nth-child(1) {
  top: 25%;
  left: 30%;
}
.face-6 .dot:nth-child(2) {
  top: 50%;
  left: 30%;
  transform: translateY(-50%);
}
.face-6 .dot:nth-child(3) {
  bottom: 25%;
  left: 30%;
}
.face-6 .dot:nth-child(4) {
  top: 25%;
  right: 30%;
}
.face-6 .dot:nth-child(5) {
  top: 50%;
  right: 30%;
  transform: translateY(-50%);
}
.face-6 .dot:nth-child(6) {
  bottom: 25%;
  right: 30%;
}

/* ğŸ¯ ä¿®æ­£ï¼šèª¿æ•´æŠ•æ“²å‹•ç•« */
.dice.rolling {
  animation: roll 1.1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  transition: none;
}

@keyframes roll {
  0% { 
    transform: rotateX(0deg) rotateY(0deg) translateY(-50px);
  }
  15% {
    transform: rotateX(180deg) rotateY(90deg) translateY(0px);
  }
  25% {
    transform: rotateX(270deg) rotateY(135deg) translateY(-25px);
  }
  35% {
    transform: rotateX(360deg) rotateY(180deg) translateY(0px);
  }
  50% { 
    transform: rotateX(540deg) rotateY(270deg) translateY(0px);
  }
  75% {
    transform: rotateX(630deg) rotateY(315deg) translateY(0px);
  }
  /* ğŸ¯ é—œéµä¿®æ­£ï¼šæ˜ç¢ºçµæŸåœ¨0åº¦ */
  100% { 
    transform: rotateX(0deg) rotateY(0deg) translateY(0px);
  }
}

.roll-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 15px rgba(0,0,0,.4);}
.roll-btn:active:not(:disabled){transform:translateY(0);}
.roll-btn:disabled{opacity:0.6;cursor:not-allowed;}

/* åº•éƒ¨åŠŸèƒ½å€ */
.bottom-bar{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:60px;
  background:#FFF8E1;
  display:flex;
  justify-content:space-around;
  align-items:center;
  z-index:100;
  border-top:2px solid rgba(0,0,0,0.1);
}

.bottom-bar button{
  flex:1;
  height:100%;
  border:none;
  background:transparent;
  color:#333;
  font-size:10px;
  font-weight:bold;
  cursor:pointer;
  transition:all .3s ease;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:2px;
}

.bottom-bar button:active{background:rgba(0,0,0,0.1);}
.bottom-bar button .icon{font-size:20px;color:#333;}
.bottom-bar button.logged-in{color:#5D4037;}

/* LINE é ­åƒ */
.line-avatar{
  width:30px;
  height:30px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #fff;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

#lineLoginBtn.has-avatar .icon{display:none;}
#lineLoginBtn .line-avatar{display:none;}
#lineLoginBtn.has-avatar .line-avatar{display:block;}

/* ç™»å…¥é é¢ */
.login-screen{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:999;padding:20px;
}
.login-screen.hidden{display:none;}
.login-box{
  background:white;border-radius:30px;
  padding:50px 40px;text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.3);
  max-width:450px;width:100%;
  animation:slideIn 0.5s ease;
}
@keyframes slideIn{
  from{opacity:0;transform:translateY(-30px);}
  to{opacity:1;transform:translateY(0);}
}
.login-box .logo{font-size:80px;margin-bottom:20px;animation:bounce 1s infinite ease-in-out;}
@keyframes bounce{
  0%,100%{transform:translateY(0);}
  50%{transform:translateY(-10px);}
}
.login-box h1{font-size:36px;color:#333;margin-bottom:15px;}
.login-box p{font-size:18px;color:#666;margin-bottom:40px;line-height:1.6;}
.login-box .line-login-btn{
  width:100%;padding:20px;
  background:#06C755;color:white;
  border:none;border-radius:15px;
  font-size:24px;font-weight:bold;
  cursor:pointer;transition:all 0.3s ease;
  display:flex;align-items:center;justify-content:center;
  gap:15px;box-shadow:0 8px 20px rgba(6,199,85,0.3);
}
.login-box .line-login-btn:hover{background:#05b04b;transform:translateY(-2px);box-shadow:0 12px 30px rgba(6,199,85,0.4);}
.login-box .line-login-btn .icon{font-size:32px;}

.shop-popup{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%) scale(0.75); /* ğŸ¯ æ•´é«”ç¸®å° */
  width:85%;
  max-width:280px; /* å¯è¦–éœ€æ±‚å†ç•¥å° */
  background:white;
  border-radius:12px;
  box-shadow:0 6px 20px rgba(0,0,0,.35);
  overflow:hidden;
  z-index:50;
  display:none;
  animation:fadeIn .4s ease;
  transform-origin:center center; /* ç¢ºä¿ç¸®æ”¾ä¸­å¿ƒä¸åç§» */
}

@keyframes fadeIn{
  from{opacity:0;transform:translate(-50%,-45%);}
  to{opacity:1;transform:translate(-50%,-50%);}
}

.shop-hero{
  width:100%;
  height:0;
  padding-bottom:65%;
  position:relative;
  overflow:hidden;
}
.shop-hero img{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  object-fit:cover;
}

.shop-body{padding:16px;background:white;}
.shop-title{font-size:18px;font-weight:bold;color:#333;margin-bottom:8px;line-height:1.3;}
.shop-desc{font-size:13px;color:#666;line-height:1.5;}
.desc-line{margin-bottom:4px;display:block;}

.shop-footer{padding:0 16px 16px;background:white;}
.shop-buttons{display:flex;flex-direction:column;gap:8px;}
.shop-buttons button{
  width:100%;
  border:none;
  border-radius:8px;
  padding:10px; /* åŸ12px â†’ 10px */
  font-size:13px; /* åŸ14px â†’ 13px */
  font-weight:bold;
  cursor:pointer;
  color:white;
  transition:all 0.2s ease;
  text-align:center;
}

.shop-buttons button:active{transform:scale(0.98);}
.shop-buttons .claim{background:#764ba2;}
.shop-buttons .close{background:#888;}
</style>
</head>
<body>

<!-- ğŸ” LINE ç™»å…¥æ­¡è¿é é¢ -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="logo">ğŸ²</div>
    <h1>æ­¡æ¨‚å¤§å¯Œç¿</h1>
    <p>æ­¡è¿ä¾†åˆ°å¥½ç‰©å•†åœˆï¼<br>è«‹å…ˆä½¿ç”¨ LINE ç™»å…¥é–‹å§‹éŠæˆ²ï¼Œ<br>æ”¶é›†å°ˆå±¬å„ªæƒ åˆ¸å§ï¼</p>
    <button class="line-login-btn" onclick="startLineLogin()">
      <span class="icon">ğŸ“±</span>
      <span>ä½¿ç”¨ LINE ç™»å…¥</span>
    </button>
  </div>
</div>

<div class="board" id="board">
  <div class="player" id="player">
    <img src="https://aiwe.cc/wp-content/uploads/2025/11/897cb201ac922a1f9ed6e6f9082e84f5.png">
  </div>

  <div class="center">
    <div class="dice-box">
      <!-- éª°å­ 1 -->
      <div class="dice-scene">
        <div class="dice" id="dice1">
          <div class="dice-face front face-1"><div class="dot"></div></div>
          <div class="dice-face back face-6">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
          </div>
          <div class="dice-face right face-3">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
          </div>
          <div class="dice-face left face-4">
            <div class="dot"></div><div class="dot"></div>
            <div class="dot"></div><div class="dot"></div>
          </div>
          <div class="dice-face top face-5">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            <div class="dot"></div><div class="dot"></div>
          </div>
          <div class="dice-face bottom face-2">
            <div class="dot"></div><div class="dot"></div>
          </div>
        </div>
      </div>
      
      <!-- éª°å­ 2 -->
      <div class="dice-scene">
        <div class="dice" id="dice2">
          <div class="dice-face front face-1"><div class="dot"></div></div>
          <div class="dice-face back face-6">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
          </div>
          <div class="dice-face right face-3">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
          </div>
          <div class="dice-face left face-4">
            <div class="dot"></div><div class="dot"></div>
            <div class="dot"></div><div class="dot"></div>
          </div>
          <div class="dice-face top face-5">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            <div class="dot"></div><div class="dot"></div>
          </div>
          <div class="dice-face bottom face-2">
            <div class="dot"></div><div class="dot"></div>
          </div>
        </div>
      </div>
    </div>
    
    <button class="roll-btn" onclick="startGame()" id="rollBtn">ğŸ² æŠ•æ“²éª°å­</button>
    <div class="msg" id="msg"></div>
  </div>
</div>

<!-- ğŸ§§ LINE Bubble é¢¨æ ¼åº—å®¶å„ªæƒ å¡ç‰‡ -->
<div class="shop-popup" id="shopPopup">
  <div class="shop-hero">
    <img id="shopImg" src="">
  </div>
  <div class="shop-body">
    <div class="shop-title" id="shopName"></div>
    <div class="shop-desc" id="shopDesc"></div>
  </div>
  <div class="shop-footer">
    <div class="shop-buttons">
      <button class="claim" id="claimBtn">æ”¶è—å„ªæƒ </button>
      <button class="close" onclick="closeShop()">æ”¾æ£„æ”¶è—</button>
    </div>
  </div>
</div>

<!-- ğŸ“± åº•éƒ¨åŠŸèƒ½åˆ— -->
<div class="bottom-bar">
  <button id="lineLoginBtn" onclick="logoutAndReLogin()">
    <span class="icon">ğŸ“±</span>
    <img class="line-avatar" id="lineAvatar" src="" alt="LINE">
    <span id="lineLoginText">LINE</span>
  </button>
  
  <button onclick="window.location.href='coupon.html'">
    <span class="icon">ğŸ«</span>
    <span>å„ªæƒ åˆ¸</span>
  </button>
  
  <button onclick="window.location.href='https://aiwe.cc/index.php/linecard_12/1460/?share=1'">
    <span class="icon">ğŸ—ºï¸</span>
    <span>åº—å®¶åœ°åœ–</span>
  </button>
</div>

<!-- éŸ³æ•ˆ -->
<audio id="bgm" loop src="https://aiwe.cc/wp-content/uploads/2025/11/901cd11beb7b52aea3f9011f2d3d33bb.mp3"></audio>
<audio id="sDice" src="https://aiwe.cc/wp-content/uploads/2025/11/77b2287cce9574aeb82a8dbbcf200050.mp3"></audio>
<audio id="sMove" src="https://aiwe.cc/wp-content/uploads/2025/11/f8bf2fa137503315a28ad81a8aee77a5.mp3"></audio>
<!-- ğŸµ æ–°å¢ï¼šæŠ½åˆ°å„ªæƒ åˆ¸éŸ³æ•ˆ -->
<audio id="couponSound">
    <source src="https://aiwe.cc/wp-content/uploads/2025/11/96b7a2f24b8df785169c1671eae6618c.mp3" type="audio/mpeg">
</audio>

<script>
// ============================================
// ğŸ” è¨»å†Šç‹€æ…‹æª¢æŸ¥ï¼ˆå¿…é ˆæ”¾åœ¨æœ€å‰é¢ï¼‰
// ============================================
function checkRegistrationStatus() {
    const userId = localStorage.getItem('lineUserId');
    const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
    const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
    
    console.log('ğŸ” æª¢æŸ¥è¨»å†Šç‹€æ…‹...');
    console.log('   userId:', userId);
    console.log('   userProfile:', userProfile);
    console.log('   registeredUsers:', registeredUsers);
    
    // å¦‚æœæ²’æœ‰ç”¨æˆ¶IDæˆ–æœªè¨»å†Šï¼Œè·³è½‰åˆ°ç™»å…¥é é¢
    if (!userId || !registeredUsers[userId] || !userProfile.nickname || !userProfile.county) {
        console.log('âŒ ç”¨æˆ¶æœªè¨»å†Šï¼Œè·³è½‰åˆ°ç™»å…¥é é¢');
        window.location.href = 'login.html';
        return false;
    }
    
    console.log('âœ… ç”¨æˆ¶å·²è¨»å†Šï¼Œå¯ä»¥é–‹å§‹éŠæˆ²');
    return true;
}

// ğŸ® éŠæˆ²æ ¸å¿ƒè®Šæ•¸èˆ‡è¨­å®š
const player = document.getElementById('player');
const board = document.getElementById('board');
const msg = document.getElementById('msg');
const dice1 = document.getElementById('dice1');
const dice2 = document.getElementById('dice2');
const rollBtn = document.getElementById('rollBtn');
const bgm = document.getElementById('bgm');
const sDice = document.getElementById('sDice');
const sMove = document.getElementById('sMove');
const couponSound = document.getElementById('couponSound'); // ğŸµ æ–°å¢å„ªæƒ åˆ¸éŸ³æ•ˆ
const shopPopup = document.getElementById('shopPopup');
const shopImg = document.getElementById('shopImg');
const shopName = document.getElementById('shopName');
const shopDesc = document.getElementById('shopDesc');
const claimBtn = document.getElementById('claimBtn');

let currentShop = null;
const rows = 9, cols = 6;
let pos = 0;

// éŠæˆ²è·¯å¾‘è¨­å®š
const path = [];
for (let x = cols - 1; x >= 0; x--) path.push({ x, y: rows - 1 });
for (let y = rows - 2; y >= 0; y--) path.push({ x: 0, y });
for (let x = 1; x < cols; x++) path.push({ x, y: 0 });
for (let y = 1; y < rows - 1; y++) path.push({ x: cols - 1, y });

// ğŸ¯ ä¿®æ­£ï¼šæ¯å€‹é¢å°æ‡‰çš„æ—‹è½‰è§’åº¦
const rotations = {
  1: 'rotateX(0deg) rotateY(0deg)',      // æ­£é¢ (front)
  2: 'rotateX(90deg) rotateY(0deg)',     // åº•é¢ (bottom) - ä¿®æ­£
  3: 'rotateX(0deg) rotateY(-90deg)',    // å³å´é¢ (right)
  4: 'rotateX(0deg) rotateY(90deg)',     // å·¦å´é¢ (left)
  5: 'rotateX(-90deg) rotateY(0deg)',    // é ‚é¢ (top) - ä¿®æ­£
  6: 'rotateX(0deg) rotateY(180deg)'     // èƒŒé¢ (back)
};

// ============================================
// ğŸ® éŠæˆ²æ ¸å¿ƒåŠŸèƒ½
// ============================================
function startGame() {
  if (bgm.paused) {
    bgm.volume = 0.3;
    bgm.play().catch(() => {});
  }
  rollDice();
}

function updatePlayer() {
  const cell = path[pos];
  const w = board.clientWidth / cols;
  const h = board.clientHeight / rows;
  let offsetX = 0;
  
  if (cell.y === rows - 1) offsetX = -w * 0.05;
  else if (cell.y === 0) offsetX = w * 0.05;
  
  if (cell.x === cols - 1 && cell.y > 0 && cell.y < rows - 1) offsetX -= w * 0.27;
  
  player.style.left = `${cell.x * w + w / 2 - player.clientWidth / 2 + offsetX}px`;
  player.style.top = `${cell.y * h + h / 2 - player.clientHeight / 2}px`;
}

// é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
function displayUserInfo() {
    const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
    if (userProfile.nickname && userProfile.county) {
        showMsg(`æ­¡è¿å›ä¾†ï¼Œ${userProfile.nickname}ï¼ä¾†è‡ª${userProfile.county}`);
        setTimeout(() => hideMsg(), 3000);
    }
}

// âœ¨ ğŸ¯ v3.1 - æœ€çµ‚å®Œç¾ç‰ˆæœ¬ï¼ˆé‚è¼¯+è¦–è¦ºéƒ½100%æ­£ç¢ºï¼‰
async function rollDice() {
  console.log('ğŸ² === é–‹å§‹æŠ•æ“²éª°å­ ===');
  
  rollBtn.disabled = true;
  rollBtn.textContent = 'ğŸ² æŠ•æ“²ä¸­...';
  
  // éš¨æ©Ÿç”Ÿæˆé»æ•¸ï¼ˆå…ˆæ±ºå®šçµæœï¼‰
  const v1 = Math.floor(Math.random() * 6) + 1;
  const v2 = Math.floor(Math.random() * 6) + 1;
  
  console.log(`   éª°å­1: ${v1} é»`);
  console.log(`   éª°å­2: ${v2} é»`);
  console.log(`   ç¸½è¨ˆ: ${v1 + v2} é»`);
  
  // æ’­æ”¾éŸ³æ•ˆ
  sDice.currentTime = 0;
  sDice.play();
  
  // å‰µå»ºPromiseç­‰å¾…å…©å€‹éª°å­å‹•ç•«éƒ½çµæŸ
  const waitForAnimations = new Promise((resolve) => {
    let dice1Done = false;
    let dice2Done = false;
    
    const checkBothDone = () => {
      if (dice1Done && dice2Done) {
        resolve();
      }
    };
    
    // ç›£è½éª°å­1å‹•ç•«çµæŸ
    const onDice1End = () => {
      dice1Done = true;
      dice1.removeEventListener('animationend', onDice1End);
      console.log('âœ… éª°å­1å‹•ç•«çµæŸ');
      checkBothDone();
    };
    
    // ç›£è½éª°å­2å‹•ç•«çµæŸ
    const onDice2End = () => {
      dice2Done = true;
      dice2.removeEventListener('animationend', onDice2End);
      console.log('âœ… éª°å­2å‹•ç•«çµæŸ');
      checkBothDone();
    };
    
    dice1.addEventListener('animationend', onDice1End);
    dice2.addEventListener('animationend', onDice2End);
  });
  
  // ğŸ¯ é‡ç½®ç‚º0åº¦
  dice1.style.transition = 'none';
  dice2.style.transition = 'none';
  dice1.style.transform = 'rotateX(0deg) rotateY(0deg)';
  dice2.style.transform = 'rotateX(0deg) rotateY(0deg)';
  
  // å¼·åˆ¶é‡ç¹ª
  void dice1.offsetWidth;
  void dice2.offsetWidth;
  
  // æ·»åŠ å‹•ç•«
  dice1.classList.add('rolling');
  dice2.classList.add('rolling');
  console.log('ğŸ¬ å‹•ç•«é–‹å§‹');
  
  // ç­‰å¾…å‹•ç•«çœŸæ­£çµæŸ
  await waitForAnimations;
  
  console.log('ğŸ¯ å‹•ç•«çµæŸï¼Œæº–å‚™è¨­ç½®æœ€çµ‚è§’åº¦');
  
  // ç§»é™¤å‹•ç•«é¡åˆ¥
  dice1.classList.remove('rolling');
  dice2.classList.remove('rolling');
  
  // ğŸ¯ é—œéµï¼šç¢ºä¿ç„¡éæ¸¡ï¼Œç›´æ¥è¨­ç½®
  dice1.style.transition = 'none';
  dice2.style.transition = 'none';
  
  // å¼·åˆ¶é‡ç¹ª
  void dice1.offsetWidth;
  void dice2.offsetWidth;
  
  // ç«‹å³è¨­ç½®æœ€çµ‚è§’åº¦
  dice1.style.transform = rotations[v1];
  dice2.style.transform = rotations[v2];
  console.log(`ğŸ¯ å·²è¨­ç½®æœ€çµ‚è§’åº¦: dice1=${v1} (${rotations[v1]}), dice2=${v2} (${rotations[v2]})`);
  
  // çŸ­æš«å»¶é²ç¢ºä¿æ¸²æŸ“å®Œæˆ
  await new Promise(r => setTimeout(r, 100));
  
  // åœæ­¢éŸ³æ•ˆä¸¦é¡¯ç¤ºçµæœ
  sDice.pause();
  
  const total = v1 + v2;
  showMsg(`ğŸ² æ“²å‡º ${v1} + ${v2} = ${total} é»ï¼`);
  rollBtn.textContent = 'ğŸ² æŠ•æ“²éª°å­';
  
  // æœ€çµ‚ç¢ºèªè§’åº¦
  console.log(`âœ… æœ€çµ‚ç¢ºèª: éª°å­1=${v1}, éª°å­2=${v2}`);
  console.log(`   éª°å­1ç•¶å‰transform: ${dice1.style.transform}`);
  console.log(`   éª°å­2ç•¶å‰transform: ${dice2.style.transform}`);
  
  console.log('âœ… éª°å­åœæ­¢ï¼Œé–‹å§‹ç§»å‹•ç©å®¶');
  movePlayer(total);
}

async function movePlayer(steps) {
  console.log(`ğŸš¶ é–‹å§‹ç§»å‹•ç©å®¶ ${steps} æ­¥...`);
  
  player.classList.add('walking');
  sMove.loop = true;
  sMove.currentTime = 0;
  sMove.play().catch(() => {});
  
  for (let i = 0; i < steps; i++) {
    pos = (pos + 1) % path.length;
    updatePlayer();
    await new Promise(r => setTimeout(r, 450));
  }
  
  player.classList.remove('walking');
  sMove.pause();
  sMove.currentTime = 0;
  
  console.log(`âœ… ç©å®¶ç§»å‹•å®Œæˆï¼Œç•¶å‰ä½ç½®: ${pos}`);
  console.log('ğŸ” æº–å‚™æª¢æŸ¥æ ¼å­äº‹ä»¶...');
  
  await checkEvent();
  
  console.log('âœ… æ ¼å­äº‹ä»¶æª¢æŸ¥å®Œæˆ');
  
  setTimeout(() => hideMsg(), 800);
  rollBtn.disabled = false;
}

// ============================================
// ğŸª æ ¼å­äº‹ä»¶è™•ç†ç³»çµ±
// ============================================
async function checkEvent() {
  try {
    console.log(`ğŸ¯ æª¢æŸ¥æ ¼å­ ${pos} çš„äº‹ä»¶...`);
    
    // è®€å–ç•¶å‰æ ¼å­çš„é…ç½®
    const cellConfig = await getCellConfig(pos);
    
    if (!cellConfig) {
      console.warn(`âš ï¸ æ‰¾ä¸åˆ°æ ¼å­ ${pos} çš„é…ç½®`);
      showMsg('æ ¼å­é…ç½®éŒ¯èª¤');
      return;
    }
    
    console.log(`ğŸ“ æ ¼å­ ${pos} é…ç½®:`, cellConfig);
    const cellType = cellConfig.æ ¼å­é¡å‹;
    console.log(`   æ ¼å­é¡å‹: ${cellType}`);
    
    // æ ¹æ“šæ ¼å­é¡å‹åŸ·è¡Œä¸åŒé‚è¼¯
    switch (cellType) {
      case 'åº—å®¶':
        console.log('ğŸª é€™æ˜¯åº—å®¶æ ¼å­ï¼Œæº–å‚™é¡¯ç¤ºåº—å®¶...');
        await handleShopCell(cellConfig);
        break;
        
      case 'çå‹µ':
        console.log('ğŸ‰ é€™æ˜¯çå‹µæ ¼å­');
        await handleRewardCell(cellConfig);
        break;
        
      case 'æ‡²ç½°':
        console.log('ğŸ’¥ é€™æ˜¯æ‡²ç½°æ ¼å­');
        await handlePenaltyCell(cellConfig);
        break;
        
      case 'æ©Ÿæœƒ':
        console.log('ğŸ² é€™æ˜¯æ©Ÿæœƒæ ¼å­');
        await handleChanceCell(cellConfig);
        break;
        
      case 'èµ·é»':
        console.log('ğŸ å›åˆ°èµ·é»');
        showMsg('ğŸ å›åˆ°èµ·é»ï¼');
        break;
        
      default:
        console.log(`â“ æœªçŸ¥æ ¼å­é¡å‹: ${cellType}`);
        showMsg(`è¸©åˆ° ${cellConfig.æ ¼å­åç¨±}`);
    }
    
  } catch (error) {
    console.error('âŒ è™•ç†æ ¼å­äº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    console.error('éŒ¯èª¤å †ç–Š:', error.stack);
    showMsg('æ ¼å­äº‹ä»¶åŸ·è¡Œå¤±æ•—');
  }
}

// è™•ç†åº—å®¶æ ¼
async function handleShopCell(cellConfig) {
  console.log('ğŸª === é–‹å§‹è™•ç†åº—å®¶æ ¼ ===');
  console.log('   æ”¶åˆ°çš„é…ç½®:', cellConfig);
  
  const category = cellConfig.åº—å®¶åˆ†é¡;
  console.log('   åº—å®¶åˆ†é¡:', category);
  
  if (!category || category === '-') {
    console.warn('âš ï¸ æ­¤æ ¼å­æ²’æœ‰æœ‰æ•ˆçš„åº—å®¶åˆ†é¡');
    showMsg('æ­¤æ ¼å­æ²’æœ‰åº—å®¶');
    return;
  }
  
  console.log(`ğŸ” å°‹æ‰¾åˆ†é¡ã€Œ${category}ã€çš„åº—å®¶...`);
  
  try {
    // å¾åº—å®¶è³‡æ–™ç¯©é¸è©²åˆ†é¡
    const shops = await loadShopsByCategory(category);
    console.log(`ğŸ“Š æ‰¾åˆ° ${shops.length} å€‹åº—å®¶:`, shops);
    
    if (shops.length === 0) {
      console.warn(`âš ï¸ åˆ†é¡ã€Œ${category}ã€æ²’æœ‰åº—å®¶è³‡æ–™`);
      showMsg(`æ‰¾ä¸åˆ°ã€Œ${category}ã€é¡å‹çš„åº—å®¶`);
      return;
    }
    
    // éš¨æ©Ÿé¸ä¸€é–“åº—å®¶
    const randomIndex = Math.floor(Math.random() * shops.length);
    const randomShop = shops[randomIndex];
    console.log(`ğŸ² éš¨æ©Ÿé¸æ“‡ç¬¬ ${randomIndex} å€‹åº—å®¶:`, randomShop);
    
    // ç¢ºä¿åº—å®¶è³‡æ–™åŒ…å«æ‰€æœ‰å¿…è¦æ¬„ä½
    currentShop = {
      "åº—å®¶åç¨±": randomShop["åº—å®¶åç¨±"] || randomShop.name || "åº—å®¶",
      "å„ªæƒ å…§å®¹": randomShop["å„ªæƒ å…§å®¹"] || randomShop.discount || "å„ªæƒ ",
      "åœ–ç‰‡ç¶²å€": randomShop["åœ–ç‰‡ç¶²å€"] || randomShop.imageUrl || randomShop.icon || "",
      
      // ğŸ¯ é—œéµä¿®æ­£ï¼šä½¿ç”¨ã€ŒåŠ LINE å»ºæ¨¡ã€ä½œç‚ºä¸»è¦æ¬„ä½åç¨±
      "åŠ LINEé€£ç¹«": randomShop["åŠ LINE å»ºæ¨¡"] || randomShop["åŠ LINEé€£ç¹«"] || randomShop.lineUrl || "",
      "åœ°å€": randomShop["åœ°å€"] || randomShop.addressUrl || "",
      
      "åº—å®¶åˆ†é¡": randomShop["åº—å®¶åˆ†é¡"] || category
    };

    console.log('ğŸ” åŠ LINE å»ºæ¨¡æ¬„ä½å…§å®¹:', randomShop["åŠ LINE å»ºæ¨¡"]);
    console.log('ğŸ” åœ°å€æ¬„ä½å…§å®¹:', randomShop["åœ°å€"]);
    console.log('âœ… è™•ç†å¾Œçš„åº—å®¶è³‡æ–™:', currentShop);
    
    // ğŸµ æ’­æ”¾æŠ½åˆ°å„ªæƒ åˆ¸éŸ³æ•ˆ
    playCouponSound();
    showShopPopup(currentShop);
    
  } catch (error) {
    console.error('âŒ è™•ç†åº—å®¶æ ¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    showMsg('è¼‰å…¥åº—å®¶è³‡æ–™å¤±æ•—');
  }
}

// ğŸµ æ–°å¢ï¼šæ’­æ”¾å„ªæƒ åˆ¸éŸ³æ•ˆå‡½æ•¸
function playCouponSound() {
    try {
        couponSound.currentTime = 0;
        couponSound.volume = 0.7;
        couponSound.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', e));
    } catch (error) {
        console.log('æ’­æ”¾å„ªæƒ åˆ¸éŸ³æ•ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    }
}

// è™•ç†çå‹µæ ¼
async function handleRewardCell(cellConfig) {
  const event = cellConfig.ç‰¹æ®Šäº‹ä»¶;
  const param = cellConfig.äº‹ä»¶åƒæ•¸;
  
  if (event === 'å‰é€²' && param) {
    showMsg(`ğŸ‰ ${cellConfig.æ ¼å­åç¨±}ï¼å‰é€² ${param} æ­¥ï¼`);
    player.classList.add('walking');
    sMove.loop = true;
    sMove.currentTime = 0;
    sMove.play().catch(() => {});
    
    for (let i = 0; i < param; i++) {
      pos = (pos + 1) % path.length;
      updatePlayer();
      await new Promise(r => setTimeout(r, 450));
    }
    
    player.classList.remove('walking');
    sMove.pause();
    sMove.currentTime = 0;
    
  } else if (event === 'å†æ“²ä¸€æ¬¡') {
    showMsg(`ğŸŠ ${cellConfig.æ ¼å­åç¨±}ï¼å†æ“²ä¸€æ¬¡éª°å­ï¼`);
    setTimeout(() => {
      rollBtn.disabled = false;
      rollBtn.click();
    }, 1500);
  } else {
    showMsg(`â­ ${cellConfig.æ ¼å­åç¨±}ï¼`);
  }
}

// è™•ç†æ‡²ç½°æ ¼
async function handlePenaltyCell(cellConfig) {
  const event = cellConfig.ç‰¹æ®Šäº‹ä»¶;
  const param = cellConfig.äº‹ä»¶åƒæ•¸;
  
  if (event === 'å¾Œé€€' && param) {
    showMsg(`ğŸ’¥ ${cellConfig.æ ¼å­åç¨±}ï¼é€€å› ${param} æ­¥ï¼`);
    player.classList.add('walking');
    sMove.loop = true;
    sMove.currentTime = 0;
    sMove.play().catch(() => {});
    
    for (let i = 0; i < param; i++) {
      pos = (pos - 1 + path.length) % path.length;
      updatePlayer();
      await new Promise(r => setTimeout(r, 300));
    }
    
    player.classList.remove('walking');
    sMove.pause();
    sMove.currentTime = 0;
  } else {
    showMsg(`âš ï¸ ${cellConfig.æ ¼å­åç¨±}ï¼`);
  }
}

// è™•ç†æ©Ÿæœƒæ ¼
async function handleChanceCell(cellConfig) {
  showMsg(`ğŸ² ${cellConfig.æ ¼å­åç¨±}ï¼æŠ½å–æ©Ÿæœƒå¡...`);
  
  await new Promise(r => setTimeout(r, 1000));
  
  const isGoodLuck = Math.random() < 0.5;
  
  if (isGoodLuck) {
    const goodEvents = [
      { msg: 'ğŸ å¥½é‹ï¼ç²å¾— 2 å¼µéš¨æ©Ÿå„ªæƒ åˆ¸ï¼', action: async () => {
        const shops = await loadShops();
        if (shops.length >= 2) {
          const shop1 = shops[Math.floor(Math.random() * shops.length)];
          const shop2 = shops[Math.floor(Math.random() * shops.length)];
          // ğŸµ æ’­æ”¾æŠ½åˆ°å„ªæƒ åˆ¸éŸ³æ•ˆ
          playCouponSound();
          await saveCoupon(shop1);
          await saveCoupon(shop2);
        }
      }},
      { msg: 'âœ¨ å¥½é‹ï¼å‚³é€åˆ°èµ·é»ï¼', action: async () => {
        pos = 0;
        updatePlayer();
      }},
      { msg: 'ğŸš€ å¥½é‹ï¼å‰é€² 5 æ­¥ï¼', action: async () => {
        player.classList.add('walking');
        sMove.loop = true;
        sMove.play().catch(() => {});
        for (let i = 0; i < 5; i++) {
          pos = (pos + 1) % path.length;
          updatePlayer();
          await new Promise(r => setTimeout(r, 450));
        }
        player.classList.remove('walking');
        sMove.pause();
      }}
    ];
    
    const event = goodEvents[Math.floor(Math.random() * goodEvents.length)];
    showMsg(event.msg);
    await event.action();
    
  } else {
    const badEvents = [
      { msg: 'ğŸ˜± å£é‹ï¼æš«åœä¸€å›åˆï¼', action: async () => {
        rollBtn.disabled = true;
        setTimeout(() => { rollBtn.disabled = false; }, 3000);
      }},
      { msg: 'â¬…ï¸ å£é‹ï¼å¾Œé€€ 5 æ­¥ï¼', action: async () => {
        player.classList.add('walking');
        sMove.loop = true;
        sMove.play().catch(() => {});
        for (let i = 0; i < 5; i++) {
          pos = (pos - 1 + path.length) % path.length;
          updatePlayer();
          await new Promise(r => setTimeout(r, 300));
        }
        player.classList.remove('walking');
        sMove.pause();
      }}
    ];
    
    const event = badEvents[Math.floor(Math.random() * badEvents.length)];
    showMsg(event.msg);
    await event.action();
  }
}

function showShopPopup(shop) {
  console.log('ğŸ“± === showShopPopup è¢«èª¿ç”¨ ===');
  
  const imgUrl = shop["åœ–ç‰‡ç¶²å€"] || shop.icon || shop.imageUrl || "";
  const shopNameText = shop["åº—å®¶åç¨±"] || shop.name || shop.shopName || "ç¥ç§˜åº—å®¶";
  let shopDescText = shop["å„ªæƒ å…§å®¹"] || shop.discount || shop.description || "é™æ™‚å„ªæƒ ï¼Œè¶•å¿«ä¾†çœ‹çœ‹ï¼";
  
  // è™•ç†æ›è¡Œ
  shopDescText = shopDescText.replace(/ã€‚/g, 'ã€‚<br>');
  
  // åœ–ç‰‡è¨­ç½®
  if (imgUrl && (imgUrl.startsWith("http://") || imgUrl.startsWith("https://"))) {
    shopImg.src = imgUrl;
    shopImg.onerror = function() {
      this.src = "https://developers-resource.landpress.line.me/fx/img/01_1_cafe.png";
    };
  } else {
    shopImg.src = "https://developers-resource.landpress.line.me/fx/img/01_1_cafe.png";
  }
  
  shopName.textContent = shopNameText;
  
  // âœ… å‰ç«¯å½ˆçª—ï¼šåªé¡¯ç¤ºå„ªæƒ å…§å®¹ï¼Œä¸é¡¯ç¤ºåŠ LINEé€£ç¹«å’Œåœ°å€
  shopDesc.innerHTML = shopDescText;
  
  shopPopup.style.display = 'block';
  claimBtn.disabled = false;
  claimBtn.textContent = "æ”¶è—å„ªæƒ ";
  
  console.log('âœ… åº—å®¶å½ˆçª—å·²é¡¯ç¤º');
}

function closeShop() {
  shopPopup.style.display = 'none';
}

// ============================================
// ğŸ« æ”¶è—æŒ‰éˆ•äº‹ä»¶
// ============================================
claimBtn.addEventListener('click', async () => {
  if (!currentShop) return;
  
  console.log('ğŸ“¦ æº–å‚™æ”¶è—çš„åº—å®¶è³‡æ–™:', currentShop);
  
  claimBtn.disabled = true;
  claimBtn.textContent = "ğŸ‰ æ”¶è—ä¸­...";
  
  try {
    const success = await saveCoupon(currentShop);
    
    if (success) {
      claimBtn.textContent = "âœ… æ”¶è—æˆåŠŸï¼";
      console.log('âœ… å„ªæƒ åˆ¸å·²æˆåŠŸä¿å­˜');
      setTimeout(() => {
        closeShop();
      }, 1500);
    } else {
      claimBtn.textContent = "âš ï¸ æ”¶è—å¤±æ•—";
      setTimeout(() => {
        claimBtn.textContent = "æ”¶è—å„ªæƒ ";
        claimBtn.disabled = false;
      }, 2000);
    }
    
  } catch (error) {
    console.error('âŒ æ”¶è—éŒ¯èª¤:', error);
    claimBtn.textContent = "âš ï¸ ç¶²è·¯éŒ¯èª¤";
    setTimeout(() => {
      claimBtn.textContent = "æ”¶è—å„ªæƒ ";
      claimBtn.disabled = false;
    }, 2000);
  }
});

// ============================================
// ğŸ“± é é¢è¼‰å…¥åˆå§‹åŒ–
// ============================================
window.addEventListener('DOMContentLoaded', async function() {
  console.log('=== ğŸ“± åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ ===');
  
  // ğŸ¯ é¦–å…ˆæª¢æŸ¥è¨»å†Šç‹€æ…‹
  if (!checkRegistrationStatus()) {
    return; // å¦‚æœæœªè¨»å†Šï¼Œåœæ­¢å¾ŒçºŒåˆå§‹åŒ–
  }
  
  console.log('ğŸ² 3D éª°å­ç³»çµ±å·²å•Ÿç”¨ï¼');
  
  if (typeof initializeApp === 'undefined') {
    console.error('âŒ common.js æœªè¼‰å…¥ï¼');
    alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼šæ‰¾ä¸åˆ° common.js');
    return;
  }
  
  // ğŸ¯ åˆå§‹åŒ–éª°å­é¡¯ç¤ºç‚º1é»
  dice1.style.transform = rotations[1];
  dice2.style.transform = rotations[1];
  console.log('âœ… éª°å­å·²åˆå§‹åŒ–ç‚º1é»');
  
  await initializeApp();
  updatePlayer();
  
  // é¡¯ç¤ºç”¨æˆ¶æ­¡è¿è¨Šæ¯
  displayUserInfo();
  
  console.log('âœ… æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');
  console.log('ğŸ“ ç•¶å‰ä½ç½®:', pos);
  console.log('ğŸ® æº–å‚™é–‹å§‹éŠæˆ²ï¼');
});

// è¨Šæ¯é¡¯ç¤ºå‡½æ•¸
function showMsg(text) {
  msg.textContent = text;
  msg.style.opacity = 1;
}

function hideMsg() {
  msg.style.opacity = 0;
}

// ç°¡åŒ–ç™»å…¥åŠŸèƒ½
function startLineLogin() {
  // æ¨¡æ“¬ç™»å…¥æˆåŠŸ
  document.getElementById('loginScreen').classList.add('hidden');
  showMsg('æ­¡è¿ï¼ŒTonyfangï¼');
}

// ğŸ¯ ä¿®æ­£ï¼šç™»å‡ºä¸¦é‡æ–°ç™»å…¥åŠŸèƒ½
function logoutAndReLogin() {
  console.log('ğŸšª åŸ·è¡Œç™»å‡ºä¸¦é‡æ–°ç™»å…¥...');
  
  // æ¸…é™¤æœ¬åœ°å„²å­˜çš„ç”¨æˆ¶è³‡æ–™
  localStorage.removeItem('lineUserId');
  localStorage.removeItem('lineDisplayName');
  localStorage.removeItem('linePictureUrl');
  localStorage.removeItem('lineLoginTime');
  localStorage.removeItem('userProfile');
  localStorage.removeItem('registeredUsers');
  
  sessionStorage.removeItem('lineUserId');
  sessionStorage.removeItem('lineDisplayName');
  sessionStorage.removeItem('linePictureUrl');
  sessionStorage.removeItem('justLoggedIn');
  sessionStorage.removeItem('registrationComplete');
  
  // é¡¯ç¤ºç™»å…¥ç•«é¢
  document.getElementById('loginScreen').classList.remove('hidden');
  
  // é‡ç½®åº•éƒ¨æŒ‰éˆ•ç‹€æ…‹
  const lineLoginBtn = document.getElementById('lineLoginBtn');
  const lineAvatar = document.getElementById('lineAvatar');
  const lineLoginText = document.getElementById('lineLoginText');
  
  lineLoginBtn.classList.remove('has-avatar');
  lineAvatar.src = '';
  lineLoginText.textContent = 'LINE';
  
  console.log('âœ… å·²ç™»å‡ºï¼Œæº–å‚™é‡æ–°ç™»å…¥');
  showMsg('è«‹é‡æ–°ç™»å…¥');
}
</script>
</body>
</html>
