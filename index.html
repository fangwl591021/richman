<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ê≠°Ê®ÇÂ§ßÂØåÁøÅ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 5px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* ÊîæÂ§ß‰∏äÊñπÊ®ôÈ†≠ */
        .header {
            background: white;
            padding: 20px 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            flex-shrink: 0;
            min-height: 100px;
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 28px;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .player-name {
            font-weight: bold;
            font-size: 24px;
        }
        
        .player-level {
            font-size: 18px;
            color: #666;
        }
        
        .stats {
            display: flex;
            gap: 30px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-icon {
            font-size: 36px;
        }
        
        .stat-value {
            font-weight: bold;
            color: #333;
            font-size: 22px;
        }
        
        .game-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 5px 0;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* Ê£ãÁõ§ÔºöÊ©´6Ê†º√óÁõ¥7Ê†º */
        .board {
            width: 100%;
            background: #f5deb3;
            position: relative;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            aspect-ratio: 6 / 7;
        }
        
        /* Ê≠£ÊñπÂΩ¢Ê†ºÂ≠êÔºö16.666% ÂØ¨Â∫¶ (100/6) */
        .cell {
            position: absolute;
            width: 16.666%;
            aspect-ratio: 1;
            background: white;
            border: 1px solid #8b4513;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cell:active {
            transform: scale(0.95);
            background: #fffacd;
        }
        
        .cell-icon {
            font-size: 50px;
            line-height: 1;
            margin-bottom: 4px;
        }
        
        .cell-name {
            font-size: 10px;
            text-align: center;
            font-weight: bold;
            color: #333;
            line-height: 1.1;
            padding: 0 2px;
        }
        
        /* ËßíËêΩÊ†ºÂ≠ê */
        .corner {
            background: linear-gradient(135deg, #2a9d8f, #3dbb9f);
            color: white;
            font-weight: bold;
        }
        
        .corner .cell-icon {
            font-size: 55px;
        }
        
        .corner .cell-name {
            font-size: 11px;
            color: white;
        }
        
        /* ‰∏çÂêåÁöÑÊàøÂ≠êÈ°èËâ≤ */
        .house-red { background: linear-gradient(135deg, #ffadad, #ffd6a5); }
        .house-blue { background: linear-gradient(135deg, #a2d2ff, #bde0fe); }
        .house-green { background: linear-gradient(135deg, #caffbf, #9bf6ff); }
        .house-pink { background: linear-gradient(135deg, #ffc8dd, #ffafcc); }
        .house-yellow { background: linear-gradient(135deg, #fdffb6, #ffd6a5); }
        .house-purple { background: linear-gradient(135deg, #cdb4db, #ffc6ff); }
        .house-orange { background: linear-gradient(135deg, #ffd6a5, #fdffb6); }
        
        /* ÁâπÊÆäÊ†ºÂ≠ê */
        .chance { 
            background: linear-gradient(135deg, #fff3cd, #ffe69c);
        }
        
        .fate { 
            background: linear-gradient(135deg, #e7d9ff, #d4bbff);
        }
        
        /* ‰∏≠Â§ÆÂçÄÂüüÔºöË∂ÖÂ§ßÔºÅ */
        .center-area {
            position: absolute;
            left: 16.666%;
            top: 14.285%;
            width: 66.666%;
            height: 71.43%;
            background: linear-gradient(135deg, #ffe4b5, #ffd700);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            border: 4px solid #8b4513;
            z-index: 1;
        }
        
        .center-title {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .center-subtitle {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }
        
        /* ÈõôÈ™∞Â≠êÂÆπÂô® */
        .dice-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* ‚úÖ Á´ãÈ´îÈ™∞Â≠êÊ®£Âºè */
        .dice {
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 20px;
            box-shadow: 
                0 5px 15px rgba(0,0,0,0.2),
                inset 0 -3px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 2px solid #f0f0f0;
        }
        
        .dice.rolling {
            animation: roll 0.5s infinite;
        }
        
        @keyframes roll {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
            100% { transform: rotate(360deg); }
        }
        
        .dice-dot {
            width: 18px;
            height: 18px;
            background: #333;
            border-radius: 50%;
            position: absolute;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* È™∞Â≠êÈªûÊï∏‰ΩçÁΩÆ */
        .dice-face-1 .dice-dot:nth-child(1) { 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
        }
        
        .dice-face-2 .dice-dot:nth-child(1) { top: 25%; left: 25%; }
        .dice-face-2 .dice-dot:nth-child(2) { bottom: 25%; right: 25%; }
        
        .dice-face-3 .dice-dot:nth-child(1) { top: 25%; left: 25%; }
        .dice-face-3 .dice-dot:nth-child(2) { 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
        }
        .dice-face-3 .dice-dot:nth-child(3) { bottom: 25%; right: 25%; }
        
        .dice-face-4 .dice-dot:nth-child(1) { top: 25%; left: 25%; }
        .dice-face-4 .dice-dot:nth-child(2) { top: 25%; right: 25%; }
        .dice-face-4 .dice-dot:nth-child(3) { bottom: 25%; left: 25%; }
        .dice-face-4 .dice-dot:nth-child(4) { bottom: 25%; right: 25%; }
        
        .dice-face-5 .dice-dot:nth-child(1) { top: 25%; left: 25%; }
        .dice-face-5 .dice-dot:nth-child(2) { top: 25%; right: 25%; }
        .dice-face-5 .dice-dot:nth-child(3) { 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
        }
        .dice-face-5 .dice-dot:nth-child(4) { bottom: 25%; left: 25%; }
        .dice-face-5 .dice-dot:nth-child(5) { bottom: 25%; right: 25%; }
        
        .dice-face-6 .dice-dot:nth-child(1) { top: 25%; left: 25%; }
        .dice-face-6 .dice-dot:nth-child(2) { top: 25%; right: 25%; }
        .dice-face-6 .dice-dot:nth-child(3) { 
            top: 50%; left: 25%; 
            transform: translateY(-50%); 
        }
        .dice-face-6 .dice-dot:nth-child(4) { 
            top: 50%; right: 25%; 
            transform: translateY(-50%); 
        }
        .dice-face-6 .dice-dot:nth-child(5) { bottom: 25%; left: 25%; }
        .dice-face-6 .dice-dot:nth-child(6) { bottom: 25%; right: 25%; }
        
        /* Ë∂ÖË∂ÖÂ§ßÊåâÈàï */
        .roll-button {
            padding: 25px 60px;
            border: none;
            border-radius: 35px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .roll-button:active:not(:disabled) {
            transform: scale(0.95);
        }
        
        .roll-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .dice-info {
            margin-top: 20px;
            color: #666;
            font-size: 20px;
            font-weight: bold;
        }
        
        .player-marker {
            position: absolute;
            width: 150px;
            height: 180px;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: none;
            z-index: 100;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            overflow: hidden;
        }
        
        /* ÊîæÂ§ßÂ∫ïÈÉ®Â∞éËà™ */
        .bottom-nav {
            background: white;
            border-radius: 15px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            margin-top: 5px;
            flex-shrink: 0;
            min-height: 100px;
        }
        
        .nav-item {
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            transition: all 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .nav-item.active {
            color: #667eea;
        }
        
        .nav-icon {
            font-size: 40px;
            margin-bottom: 8px;
        }
        
        .nav-label {
            font-size: 18px;
            font-weight: bold;
        }
        
        .badge {
            position: absolute;
            top: 15px;
            right: 25px;
            background: #ff4757;
            color: white;
            border-radius: 10px;
            padding: 4px 8px;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* ÂÑ™ÊÉ†Âà∏ÂΩàÂá∫Ë¶ñÁ™ó - Ë¶ÜËìã‰∏≠Â§ÆÂçÄÂüü */
        .coupon-modal {
            display: none;
            position: absolute;
            left: 16.666%;
            top: 14.285%;
            width: 66.666%;
            height: 71.43%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 200;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
            border: 5px solid #ffd700;
            animation: popUp 0.5s;
        }
        
        .coupon-modal.show {
            display: flex;
        }
        
        .coupon-icon {
            font-size: 120px;
            margin-bottom: 20px;
        }
        
        .coupon-title {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .coupon-category {
            font-size: 28px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .coupon-card {
            background: linear-gradient(135deg, #fff5f5, #ffe5e5);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            width: 90%;
            max-width: 400px;
        }
        
        .coupon-reward-title {
            color: #ff6b6b;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 28px;
        }
        
        .coupon-reward-content {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .coupon-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            width: 90%;
            max-width: 400px;
        }
        
        .coupon-button {
            padding: 22px;
            border: none;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        
        .save-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .close-button {
            background: #f0f0f0;
            color: #666;
        }
        
        .coupon-button:active {
            transform: scale(0.95);
        }
        
        /* ÊîæÂ§ßÂÑ™ÊÉ†Âà∏ÂàóË°® */
        .coupon-list-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .coupon-list-modal.show {
            display: flex;
        }
        
        .coupon-list-content {
            background: white;
            border-radius: 25px;
            padding: 30px;
            width: 70%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            animation: popUp 0.3s;
            text-align: center;
        }
        
        .coupon-list-title {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 25px;
            color: #333;
        }
        
        .coupon-list-items {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-top: 25px;
        }
        
        .coupon-list-item {
            background: linear-gradient(135deg, #f3e7ff, #ffd6ff);
            border-radius: 20px;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .coupon-list-info h3 {
            font-size: 26px;
            margin-bottom: 10px;
        }
        
        .coupon-list-category {
            font-size: 22px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .coupon-list-discount {
            color: #667eea;
            font-weight: bold;
            font-size: 24px;
        }
        
        .coupon-list-expiry {
            font-size: 18px;
            color: #666;
            margin-top: 10px;
        }
        
        .use-coupon-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 18px 30px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 22px;
        }
        
        .empty-coupons {
            text-align: center;
            padding: 50px;
        }
        
        .empty-coupons-icon {
            font-size: 100px;
            margin-bottom: 25px;
        }
        
        .empty-coupons-text {
            color: #999;
            font-size: 28px;
            margin-bottom: 15px;
        }
        
        .empty-coupons-subtext {
            font-size: 22px;
            color: #ccc;
            margin-top: 15px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            animation: popUp 0.3s;
            text-align: center;
        }
        
        @keyframes popUp {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .modal-icon {
            font-size: 80px;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 26px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .modal-category {
            font-size: 18px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .reward-card {
            background: linear-gradient(135deg, #fff5f5, #ffe5e5);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .reward-title {
            color: #ff6b6b;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .reward-content {
            font-size: 22px;
            font-weight: bold;
            color: #333;
        }
        
        .action-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
        
        .status-message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: bold;
            pointer-events: none;
        }
        
        .status-message.show {
            opacity: 1;
        }
        
        .cell.highlight {
            animation: pulse 0.5s;
            box-shadow: 0 0 20px rgba(255,215,0,0.9) inset;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Èü≥Ê®ÇÊéßÂà∂ÊåâÈàï */
        .music-control {
            position: fixed;
            bottom: 120px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 100;
            font-size: 28px;
            transition: all 0.3s;
        }
        
        .music-control:hover {
            transform: scale(1.1);
        }
        
        .music-control.muted {
            background: #f0f0f0;
            color: #999;
        }

        .nav-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
        }

        .nav-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="player-info">
            <div class="avatar" id="headerAvatar">P</div>
            <div>
                <div class="player-name" id="headerPlayerName">Áé©ÂÆ∂</div>
                <div class="player-level">Lv.5</div>
            </div>
        </div>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value" id="coins">1000</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">üé≤</div>
                <div class="stat-value" id="diceCount">10</div>
            </div>
        </div>
    </div>

    <div class="game-container">
        <div class="board" id="board"></div>
        <div class="status-message" id="statusMessage"></div>
        
        <!-- ÂÑ™ÊÉ†Âà∏ÂΩàÂá∫Ë¶ñÁ™ó -->
        <div class="coupon-modal" id="couponModal">
            <div class="coupon-icon" id="couponIcon">üé´</div>
            <div class="coupon-title" id="couponShopName">ÂàùÁÜüÁöÑÊûúÂ≠ê</div>
            <div class="coupon-category" id="couponCategory">ÁæéÈ£ü</div>
            
            <div class="coupon-card">
                <div class="coupon-reward-title">ÈôêÊôÇÂÑ™ÊÉ†</div>
                <div class="coupon-reward-content" id="couponDiscount">9Êäò</div>
            </div>
            
            <div class="coupon-actions">
                <button class="coupon-button save-button" onclick="saveCoupon()">ÂÑ≤Â≠òÂÑ™ÊÉ†Âà∏</button>
                <button class="coupon-button close-button" onclick="closeCouponModal()">ÈóúÈñâ</button>
            </div>
        </div>
        
        <!-- ÂÑ™ÊÉ†Âà∏ÂàóË°®Ë¶ñÁ™ó -->
        <div class="coupon-list-modal" id="couponListModal">
            <div class="coupon-list-content" id="couponListContent"></div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('game')">
            <div class="nav-icon">üéÆ</div>
            <div class="nav-label">ÈÅäÊà≤</div>
        </button>
        <button class="nav-item" onclick="switchTab('coupons')">
            <div class="nav-icon">üé´</div>
            <div class="nav-label">ÂÑ™ÊÉ†Âà∏</div>
            <span class="badge" id="couponBadge">0</span>
        </button>
        <button class="nav-item" onclick="switchTab('map')">
            <div class="nav-icon">üó∫Ô∏è</div>
            <div class="nav-label">Âú∞Âúñ</div>
        </button>
        <button class="nav-item" onclick="switchTab('profile')">
            <div class="nav-icon" id="profileNavIcon">üë§</div>
            <div class="nav-label">ÊàëÁöÑ</div>
        </button>
    </div>

    <!-- Èü≥Ê®ÇÊéßÂà∂ÊåâÈàï -->
    <div class="music-control" id="musicControl" onclick="toggleMusic()">
        <span id="musicIcon">üéµ</span>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent"></div>
    </div>

    <!-- Èü≥Êïà -->
    <audio id="backgroundMusic" loop>
        <source src="https://aiwe.cc/wp-content/uploads/2025/11/901cd11beb7b52aea3f9011f2d3d33bb.mp3" type="audio/mpeg">
    </audio>
    <audio id="diceSound">
        <source src="https://aiwe.cc/wp-content/uploads/2025/11/77b2287cce9574aeb82a8dbbcf200050.mp3" type="audio/mpeg">
    </audio>
    <audio id="moveSound">
        <source src="https://aiwe.cc/wp-content/uploads/2025/11/f8bf2fa137503315a28ad81a8aee77a5.mp3" type="audio/mpeg">
    </audio>
    <audio id="couponSound">
        <source src="https://aiwe.cc/wp-content/uploads/2025/11/96b7a2f24b8df785169c1671eae6618c.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ==================== Ë®≠ÂÆö ====================
        // Google Sheets Ë®≠ÂÆö
        const SHEET_CONFIG = {
            SHEET_ID: '1-qvp5x8VJa_vFULJy8dfT3FjQwLDkGV8ECyeCiwJpkU',
            SHEET_NAME: '2025/11',
            API_URL: 'https://script.google.com/macros/s/AKfycbwwO2pMBDAADUEZ8NKYbicrB3_LlcL2u3-bZZF5xXjrgBxNlHLbXXLT_N7uorJgYhPB/exec'
        };

        // ÈÅäÊà≤ÁãÄÊÖã
        const gameState = {
            playerPosition: 0,
            diceValue1: 1,
            diceValue2: 1,
            isRolling: false,
            coins: 1000,
            diceCount: 10,
            boardData: [],
            coupons: [],
            userId: 'TEMP_USER',
            displayName: 'Áé©ÂÆ∂',
            pictureUrl: '',
            isMoving: false,
            shopData: [],
            apiLoaded: false,
            currentCoupon: null,
            musicEnabled: true,
            soundEnabled: true
        };

        // Èü≥ÊïàÂÖÉÁ¥†
        const backgroundMusic = document.getElementById('backgroundMusic');
        const diceSound = document.getElementById('diceSound');
        const moveSound = document.getElementById('moveSound');
        const couponSound = document.getElementById('couponSound');

        const houseIcons = ['üè™', 'üè¨', 'üè¢', 'üè®', 'üè©', 'üè´', 'üè¶', 'üèõÔ∏è', 'üèóÔ∏è', 'üè§', 'üè£', 'üè•', '‚õ™', 'üïå'];
        const houseColors = ['house-red', 'house-blue', 'house-green', 'house-pink', 'house-yellow', 'house-purple', 'house-orange'];

        // 22Ê†º‰ΩçÁΩÆ
        const cellPositions = [
            { left: '83.333%', top: '85.714%', class: 'corner' },
            { left: '66.666%', top: '85.714%', class: 'cell' },
            { left: '50%', top: '85.714%', class: 'cell' },
            { left: '33.333%', top: '85.714%', class: 'cell' },
            { left: '16.666%', top: '85.714%', class: 'cell' },
            { left: '0%', top: '85.714%', class: 'corner' },
            { left: '0%', top: '71.428%', class: 'cell' },
            { left: '0%', top: '57.142%', class: 'cell' },
            { left: '0%', top: '42.857%', class: 'cell' },
            { left: '0%', top: '28.571%', class: 'cell' },
            { left: '0%', top: '14.285%', class: 'cell' },
            { left: '0%', top: '0%', class: 'corner' },
            { left: '16.666%', top: '0%', class: 'cell' },
            { left: '33.333%', top: '0%', class: 'cell' },
            { left: '50%', top: '0%', class: 'cell' },
            { left: '66.666%', top: '0%', class: 'cell' },
            { left: '83.333%', top: '0%', class: 'corner' },
            { left: '83.333%', top: '14.285%', class: 'cell' },
            { left: '83.333%', top: '28.571%', class: 'cell' },
            { left: '83.333%', top: '42.857%', class: 'cell' },
            { left: '83.333%', top: '57.142%', class: 'cell' },
            { left: '83.333%', top: '71.428%', class: 'cell' }
        ];

        // ==================== ‚úÖ Á∞°ÂåñÁöÑÁôªÂÖ•Ê™¢Êü• ====================
        
        // Ê™¢Êü•ÁôªÂÖ•ÁãÄÊÖãÔºàÂè™Ê™¢Êü• localStorageÔºâ
function checkLogin() {
    console.log('üîç Ê™¢Êü•ÁôªÂÖ•ÁãÄÊÖã...');
    
    const userId = localStorage.getItem('lineUserId');
    const displayName = localStorage.getItem('lineDisplayName');
    const pictureUrl = localStorage.getItem('linePictureUrl');
    
    console.log('localStorage Ë≥áÊñô:');
    console.log('- userId:', userId);
    console.log('- displayName:', displayName);
    console.log('- pictureUrl:', pictureUrl);
    
    if (!userId) {
        // Êú™ÁôªÂÖ•ÔºåË∑≥ËΩâÂà∞ÁôªÂÖ•È†ÅÈù¢
        console.log('‚ùå Êú™ÁôªÂÖ•ÔºåË∑≥ËΩâÂà∞ login.html');
        
        // ‚úÖ Ê∑ªÂä†ÂèÉÊï∏ÔºåÈò≤Ê≠¢ÁÑ°ÈôêÂæ™Áí∞
        window.location.href = 'login.html?from=index';
        return false;
    }
    
    // Â∑≤ÁôªÂÖ•ÔºåÊõ¥Êñ∞ÈÅäÊà≤ÁãÄÊÖã
    gameState.userId = userId;
    gameState.displayName = displayName || 'Áé©ÂÆ∂';
    gameState.pictureUrl = pictureUrl || '';
    
    console.log('‚úÖ Â∑≤ÁôªÂÖ•:', gameState.displayName);
    console.log('‚úÖ Áî®Êà∂ID:', gameState.userId);
    
    // Êõ¥Êñ∞‰ªãÈù¢
    updateUserInterface();
    
    return true;
}
        
        // Êõ¥Êñ∞Áî®Êà∂‰ªãÈù¢
        function updateUserInterface() {
            // Êõ¥Êñ∞È†≠ÂÉè
            const headerAvatar = document.getElementById('headerAvatar');
            const headerPlayerName = document.getElementById('headerPlayerName');
            
            if (gameState.pictureUrl) {
                headerAvatar.innerHTML = `<img src="${gameState.pictureUrl}" alt="È†≠ÂÉè">`;
            } else {
                headerAvatar.textContent = gameState.displayName.charAt(0);
            }
            
            headerPlayerName.textContent = gameState.displayName;
            
            // Êõ¥Êñ∞Â∫ïÈÉ®Â∞éËà™
            const profileNavIcon = document.getElementById('profileNavIcon');
            if (gameState.pictureUrl) {
                profileNavIcon.innerHTML = `<div class="nav-avatar"><img src="${gameState.pictureUrl}" alt="È†≠ÂÉè"></div>`;
            } else {
                profileNavIcon.innerHTML = `<div class="nav-avatar" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px;">${gameState.displayName.charAt(0)}</div>`;
            }
        }
        
        // ÁôªÂá∫ÂáΩÊï∏
        function logout() {
            if (confirm('Á¢∫ÂÆöË¶ÅÁôªÂá∫ÂóéÔºü')) {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        }

        // ==================== ÂàùÂßãÂåñ ====================

        window.onload = async function() {
            console.log('üéÆ ÈÅäÊà≤ËºâÂÖ•‰∏≠...');
            showStatusMessage('ËºâÂÖ•ÈÅäÊà≤Ë≥áÊñô‰∏≠...');
            
            try {
                // ‚úÖ Ê™¢Êü•ÁôªÂÖ•ÁãÄÊÖã
                if (!checkLogin()) {
                    // ÊúÉËá™ÂãïË∑≥ËΩâÂà∞ login.html
                    return;
                }
                
                // ËºâÂÖ•Ë≥áÊñô
                await loadShopDataFromAPI();
                initializeGameData();
                await loadCouponsFromSheet();
                
                renderBoard();
                updateStats();
                
                setTimeout(() => {
                    if (gameState.musicEnabled) {
                        backgroundMusic.volume = 0.3;
                        backgroundMusic.play().catch(e => {
                            console.log('ËÉåÊôØÈü≥Ê®ÇÈúÄË¶ÅÁî®Êà∂‰∫§‰∫íÂæåÊâçËÉΩÊí≠Êîæ');
                        });
                    }
                }, 1000);
                
                setTimeout(() => {
                    hideStatusMessage();
                }, 500);
                
            } catch (error) {
                console.error('ÂàùÂßãÂåñÂ§±Êïó:', error);
                showStatusMessage('ÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢', 3000);
            }
        };

        // ==================== ÈÅäÊà≤ÈÇèËºØÂáΩÊï∏Ôºà‰øùÊåÅ‰∏çËÆäÔºâ====================

        function renderBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';

            gameState.boardData.forEach((cell) => {
                const pos = cellPositions[cell.id];
                const cellDiv = document.createElement('div');
                cellDiv.className = `${pos.class}`;
                
                if (cell.color) cellDiv.classList.add(cell.color);
                if (cell.type === 'chance') cellDiv.classList.add('chance');
                if (cell.type === 'fate') cellDiv.classList.add('fate');
                
                cellDiv.style.left = pos.left;
                cellDiv.style.top = pos.top;
                cellDiv.id = `cell-${cell.id}`;
                cellDiv.onclick = () => showCellInfo(cell);

                cellDiv.innerHTML = `
                    <div class="cell-icon">${cell.icon || '‚ùì'}</div>
                    ${cell.name ? `<div class="cell-name">${cell.name}</div>` : ''}
                `;
                board.appendChild(cellDiv);
            });

            const centerDiv = document.createElement('div');
            centerDiv.className = 'center-area';
            centerDiv.innerHTML = `
                <div class="center-title">ÂúñÊ®ôÂ§ßÂØåÁøÅ</div>
                <div class="center-subtitle">Êî∂ÈõÜÂÑ™ÊÉ†Âà∏ÔºåË¥èÂæóÁçéÂãµÔºÅ</div>
                <div class="dice-container">
                    <div class="dice dice-face-1" id="dice1">
                        <div class="dice-dot"></div>
                    </div>
                    <div class="dice dice-face-1" id="dice2">
                        <div class="dice-dot"></div>
                    </div>
                </div>
                <button class="roll-button" id="rollButton" onclick="rollDice()">
                    ÊäïÊì≤È™∞Â≠ê
                </button>
                <div class="dice-info">Ââ©È§ò: <span id="remainingDice">${gameState.diceCount}</span> Ê¨°</div>
            `;
            board.appendChild(centerDiv);

            createPlayerMarker();
        }

        function createPlayerMarker() {
            const board = document.getElementById('board');
            const marker = document.createElement('div');
            marker.className = 'player-marker';
            marker.id = 'playerMarker';
            
            marker.innerHTML = `
                <img src="https://aiwe.cc/wp-content/uploads/2025/11/897cb201ac922a1f9ed6e6f9082e84f5.png" 
                     alt="Áé©ÂÆ∂" 
                     style="width: 100%; height: 100%; object-fit: contain; border-radius: 50%;"
                     onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'font-size:80px;\\'>üéÆ</div>';">
            `;
            
            board.appendChild(marker);
            updatePlayerPosition();
        }

        function updatePlayerPosition() {
            const marker = document.getElementById('playerMarker');
            const cell = gameState.boardData.find(c => c.id === gameState.playerPosition);
            if (!marker || !cell) return;

            const pos = cellPositions[cell.id];
            const board = document.getElementById('board');
            const boardWidth = board.offsetWidth;
            const boardHeight = board.offsetHeight;

            const leftPercent = parseFloat(pos.left);
            const topPercent = parseFloat(pos.top);
            
            const cellSize = boardWidth * 0.16666;
            
            let offsetX = 0;
            let offsetY = 0;
            
            if (cell.id >= 0 && cell.id <= 4) {
                offsetY = -cellSize * 0.3;
            } else if (cell.id >= 6 && cell.id <= 10) {
                offsetX = cellSize * 0.3;
            } else if (cell.id >= 12 && cell.id <= 15) {
                offsetY = cellSize * 0.3;
            } else if (cell.id >= 17 && cell.id <= 21) {
                offsetX = -cellSize * 0.3;
            } else {
                const cornerOffset = cellSize * 0.3;
                if (cell.id === 0) {
                    offsetX = -cornerOffset;
                    offsetY = -cornerOffset;
                } else if (cell.id === 5) {
                    offsetX = cornerOffset;
                    offsetY = -cornerOffset;
                } else if (cell.id === 11) {
                    offsetX = cornerOffset;
                    offsetY = cornerOffset;
                } else if (cell.id === 16) {
                    offsetX = -cornerOffset;
                    offsetY = cornerOffset;
                }
            }

            const finalLeft = (leftPercent / 100) * boardWidth + (cellSize / 2) + offsetX;
            const finalTop = (topPercent / 100) * boardHeight + (cellSize / 2) + offsetY;

            marker.style.left = `${finalLeft}px`;
            marker.style.top = `${finalTop}px`;
        }

        async function loadCouponsFromSheet() {
            try {
                const params = new URLSearchParams({
                    action: 'getCoupons',
                    userId: gameState.userId,
                    sheetName: SHEET_CONFIG.SHEET_NAME,
                    t: Date.now()
                });

                const url = `${SHEET_CONFIG.API_URL}?${params.toString()}`;
                const response = await fetch(url);
                const text = await response.text();
                
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    console.log('ÂõûÊáâ‰∏çÊòØ JSON:', text);
                    return;
                }
                
                if (result.success && result.data) {
                    gameState.coupons = result.data.map(row => ({
                        couponId: row[1],
                        shopName: row[2],
                        discount: row[3],
                        category: row[4],
                        icon: row[5],
                        createTime: row[6],
                        expiry: formatDate(new Date(parseInt(row[7]))),
                        status: row[9]
                    }));
                    console.log(`Âæû Google Sheets ËºâÂÖ• ${gameState.coupons.length} ÂºµÂÑ™ÊÉ†Âà∏`);
                }
            } catch (error) {
                console.error('Âæû Google Sheets ËºâÂÖ•ÂÑ™ÊÉ†Âà∏Â§±Êïó:', error);
            }
        }

        async function saveCouponToSheet(coupon) {
            try {
                const params = new URLSearchParams({
                    action: 'saveCoupon',
                    userId: gameState.userId,
                    couponId: coupon.couponId,
                    shopName: encodeURIComponent(coupon.shopName),
                    discount: encodeURIComponent(coupon.discount),
                    category: encodeURIComponent(coupon.category),
                    icon: encodeURIComponent(coupon.icon),
                    createTime: coupon.createTime,
                    expiryDate: coupon.expiryDate,
                    usedTime: '',
                    status: 'active',
                    usedShop: '',
                    sheetName: SHEET_CONFIG.SHEET_NAME,
                    t: Date.now()
                });

                const url = `${SHEET_CONFIG.API_URL}?${params.toString()}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const text = await response.text();
                
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    return true;
                }
                
                return result.success;
            } catch (error) {
                console.error('ÂÑ≤Â≠òÂà∞ Google Sheets Â§±Êïó:', error);
                return false;
            }
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        async function loadShopDataFromAPI() {
            if (!SHEET_CONFIG.API_URL) {
                useDefaultShopData();
                return;
            }

            try {
                const params = new URLSearchParams({
                    action: 'getShops',
                    t: Date.now()
                });

                const url = `${SHEET_CONFIG.API_URL}?${params.toString()}`;
                const response = await fetch(url);
                const text = await response.text();
                
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    useDefaultShopData();
                    return;
                }
                
                if (result.success && result.data) {
                    gameState.shopData = result.data;
                    gameState.apiLoaded = true;
                    console.log(`ËºâÂÖ• ${result.data.length} ÈñìÂ∫óÂÆ∂`);
                } else {
                    useDefaultShopData();
                }
            } catch (error) {
                useDefaultShopData();
            }
        }

        function useDefaultShopData() {
            gameState.shopData = [
                {ID: 'SHOP0001', 'Â∫óÂÆ∂ÂêçÁ®±': 'ÂàùÁÜüÁöÑÊûúÂ≠ê', 'ÂàÜÈ°û': 'ÁæéÈ£ü', 'ÂúñÁ§∫': 'üçé', 'ÂÑ™ÊÉ†ÂÖßÂÆπ': '9Êäò'},
                {ID: 'SHOP0002', 'Â∫óÂÆ∂ÂêçÁ®±': 'ÂíñÂï°Â∞èÈ§®', 'ÂàÜÈ°û': 'ÂíñÂï°Âª≥', 'ÂúñÁ§∫': '‚òï', 'ÂÑ™ÊÉ†ÂÖßÂÆπ': 'Á¨¨‰∫åÊùØÂçäÂÉπ'},
                {ID: 'SHOP0003', 'Â∫óÂÆ∂ÂêçÁ®±': 'ÊôÇÂ∞öÊ≤ôÈæç', 'ÂàÜÈ°û': 'ÁæéÈ´Æ', 'ÂúñÁ§∫': '‚úÇÔ∏è', 'ÂÑ™ÊÉ†ÂÖßÂÆπ': 'Ê¥óÂä†Ââ™8Êäò'},
                {ID: 'SHOP0004', 'Â∫óÂÆ∂ÂêçÁ®±': 'ÊúçÈ£æÂ∫ó', 'ÂàÜÈ°û': 'ÊúçÈ£æ', 'ÂúñÁ§∫': 'üëï', 'ÂÑ™ÊÉ†ÂÖßÂÆπ': '85ÊäòÂÑ™ÊÉ†'},
                {ID: 'SHOP0005', 'Â∫óÂÆ∂ÂêçÁ®±': 'Ë∂ÖÂ∏Ç', 'ÂàÜÈ°û': 'Ë∂ÖÂ∏Ç', 'ÂúñÁ§∫': 'üõí', 'ÂÑ™ÊÉ†ÂÖßÂÆπ': 'ÊªøÁôæÊäò20'},
                {ID: 'SHOP0006', 'Â∫óÂÆ∂ÂêçÁ®±': 'Êõ∏Â∫ó', 'ÂàÜÈ°û': 'Êõ∏Â∫ó', 'ÂúñÁ§∫': 'üìö', 'ÂÑ™ÊÉ†ÂÖßÂÆπ': 'Ë≤∑‰∫åÈÄÅ‰∏Ä'},
                {ID: 'SHOP0007', 'Â∫óÂÆ∂ÂêçÁ®±': '3CË≥£Â†¥', 'ÂàÜÈ°û': '3C', 'ÂúñÁ§∫': 'üì±', 'ÂÑ™ÊÉ†ÂÖßÂÆπ': 'ÈÖç‰ª∂8Êäò'},
                {ID: 'SHOP0008', 'Â∫óÂÆ∂ÂêçÁ®±': 'ÂÆ∂Â±ÖË≥£Â†¥', 'ÂàÜÈ°û': 'ÂÆ∂Â±Ö', 'ÂúñÁ§∫': 'üè†', 'ÂÑ™ÊÉ†ÂÖßÂÆπ': 'ÊªøÂçÉÈÄÅÁôæ'},
                {ID: 'SHOP0009', 'Â∫óÂÆ∂ÂêçÁ®±': 'Â®õÊ®Ç‰∏≠ÂøÉ', 'ÂàÜÈ°û': 'Â®õÊ®Ç', 'ÂúñÁ§∫': 'üéÆ', 'ÂÑ™ÊÉ†ÂÖßÂÆπ': 'Ë≤∑‰∏ÄÂ∞èÊôÇÈÄÅÂçäÂ∞èÊôÇ'},
                {ID: 'SHOP0010', 'Â∫óÂÆ∂ÂêçÁ®±': 'Â£ΩÂè∏Â∫ó', 'ÂàÜÈ°û': 'ÁæéÈ£ü', 'ÂúñÁ§∫': 'üç£', 'ÂÑ™ÊÉ†ÂÖßÂÆπ': 'Â•óÈ§ê9Êäò'}
            ];
        }

        function initializeGameData() {
            gameState.boardData = [
                { id: 0, type: 'start', name: 'Ëµ∑Èªû', icon: 'üèÅ' },
                { id: 5, type: 'jail', name: 'Áõ£ÁçÑ', icon: 'üöì' },
                { id: 11, type: 'goback', name: 'ÂÄíÈÄÄ3Ê≠•', icon: '‚è™' },
                { id: 16, type: 'gotojail', name: 'ÈÄ≤Áõ£ÁçÑ', icon: 'üö®' },
                { id: 1, type: 'shop', icon: houseIcons[0], color: houseColors[0] },
                { id: 2, type: 'shop', icon: houseIcons[1], color: houseColors[1] },
                { id: 3, type: 'shop', icon: houseIcons[2], color: houseColors[2] },
                { id: 4, type: 'shop', icon: houseIcons[3], color: houseColors[3] },
                { id: 6, type: 'shop', icon: houseIcons[4], color: houseColors[4] },
                { id: 7, type: 'shop', icon: houseIcons[5], color: houseColors[5] },
                { id: 8, type: 'shop', icon: houseIcons[6], color: houseColors[6] },
                { id: 9, type: 'shop', icon: houseIcons[7], color: houseColors[0] },
                { id: 10, type: 'shop', icon: houseIcons[8], color: houseColors[1] },
                { id: 12, type: 'shop', icon: houseIcons[9], color: houseColors[2] },
                { id: 13, type: 'shop', icon: houseIcons[10], color: houseColors[3] },
                { id: 14, type: 'shop', icon: houseIcons[11], color: houseColors[4] },
                { id: 15, type: 'shop', icon: houseIcons[12], color: houseColors[5] },
                { id: 17, type: 'chance', name: 'Ê©üÊúÉ', icon: 'üéÅ' },
                { id: 18, type: 'fate', name: 'ÂëΩÈÅã', icon: '‚≠ê' },
                { id: 19, type: 'shop', icon: houseIcons[13], color: houseColors[6] },
                { id: 20, type: 'shop', icon: houseIcons[0], color: houseColors[0] },
                { id: 21, type: 'shop', icon: houseIcons[1], color: houseColors[1] }
            ];
        }

        function rollDice() {
            if (gameState.isRolling || gameState.diceCount === 0 || gameState.isMoving) return;

            gameState.isRolling = true;
            gameState.diceCount--;
            
            const dice1 = document.getElementById('dice1');
            const dice2 = document.getElementById('dice2');
            const button = document.getElementById('rollButton');
            
            if (!dice1 || !dice2 || !button) return;
            
            dice1.classList.add('rolling');
            dice2.classList.add('rolling');
            button.disabled = true;
            button.textContent = 'ÊäïÊì≤‰∏≠...';
            updateStats();

            if (gameState.soundEnabled) {
                diceSound.currentTime = 0;
                diceSound.play().catch(e => console.log('È™∞Â≠êÈü≥ÊïàÊí≠ÊîæÂ§±Êïó'));
            }

            let count = 0;
            const interval = setInterval(() => {
                gameState.diceValue1 = Math.floor(Math.random() * 6) + 1;
                gameState.diceValue2 = Math.floor(Math.random() * 6) + 1;
                updateDiceFace(1, gameState.diceValue1);
                updateDiceFace(2, gameState.diceValue2);
                count++;

                if (count > 10) {
                    clearInterval(interval);
                    dice1.classList.remove('rolling');
                    dice2.classList.remove('rolling');
                    setTimeout(() => movePlayer(gameState.diceValue1 + gameState.diceValue2), 300);
                }
            }, 100);
        }

        function updateDiceFace(diceNum, value) {
            const dice = document.getElementById(`dice${diceNum}`);
            if (!dice) return;
            
            dice.className = `dice dice-face-${value}`;
            dice.innerHTML = '';
            for (let i = 0; i < value; i++) {
                const dot = document.createElement('div');
                dot.className = 'dice-dot';
                dice.appendChild(dot);
            }
        }

        async function movePlayer(steps) {
            if (gameState.isMoving) return;
            
            gameState.isMoving = true;
            const button = document.getElementById('rollButton');
            if (button) button.disabled = true;
            
            showStatusMessage(`ÁßªÂãï ${steps} Ê≠•...`);

            for (let i = 0; i < steps; i++) {
                gameState.playerPosition = (gameState.playerPosition + 1) % 22;
                updatePlayerPosition();
                highlightCell(gameState.playerPosition);
                
                if (gameState.soundEnabled) {
                    moveSound.currentTime = 0;
                    moveSound.play().catch(e => console.log('ÁßªÂãïÈü≥ÊïàÊí≠ÊîæÂ§±Êïó'));
                    
                    setTimeout(() => {
                        if (!moveSound.paused) {
                            moveSound.pause();
                            moveSound.currentTime = 0;
                        }
                    }, 300);
                }
                
                await sleep(500);
            }

            const cell = gameState.boardData.find(c => c.id === gameState.playerPosition);
            if (cell) await handleCell(cell);

            gameState.isRolling = false;
            gameState.isMoving = false;
            if (button) {
                button.disabled = gameState.diceCount === 0;
                button.textContent = gameState.diceCount === 0 ? 'È™∞Â≠êÁî®ÂÆå‰∫Ü' : 'ÊäïÊì≤È™∞Â≠ê';
            }
            hideStatusMessage();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function highlightCell(cellId) {
            document.querySelectorAll('.cell, .corner').forEach(c => c.classList.remove('highlight'));
            const cell = document.getElementById(`cell-${cellId}`);
            if (cell) cell.classList.add('highlight');
        }

        async function handleCell(cell) {
            switch(cell.type) {
                case 'shop':
                    gameState.coins += 50;
                    const randomShop = gameState.shopData[Math.floor(Math.random() * gameState.shopData.length)];
                    if (randomShop) {
                        showCouponModal(cell, randomShop);
                        gameState.currentCoupon = randomShop;
                        
                        if (gameState.soundEnabled) {
                            couponSound.currentTime = 0;
                            couponSound.play().catch(e => console.log('ÂÑ™ÊÉ†Âà∏Èü≥ÊïàÊí≠ÊîæÂ§±Êïó'));
                        }
                    }
                    break;
                case 'chance':
                    gameState.coins += 100;
                    gameState.diceCount += 2;
                    showCellInfo(cell);
                    break;
                case 'fate':
                    const bonus = Math.random() > 0.5 ? 200 : -100;
                    gameState.coins = Math.max(0, gameState.coins + bonus);
                    showCellInfo(cell);
                    break;
                case 'start':
                    gameState.coins += 100;
                    showCellInfo(cell);
                    break;
                case 'goback':
                    showStatusMessage('ÂÄíÈÄÄ3Ê≠•ÔºÅ');
                    await sleep(1000);
                    for (let i = 0; i < 3; i++) {
                        gameState.playerPosition = (gameState.playerPosition - 1 + 22) % 22;
                        updatePlayerPosition();
                        highlightCell(gameState.playerPosition);
                        await sleep(500);
                    }
                    showCellInfo(cell);
                    break;
                case 'gotojail':
                    gameState.playerPosition = 5;
                    updatePlayerPosition();
                    showCellInfo(cell);
                    break;
                default:
                    showCellInfo(cell);
            }
            
            updateStats();
        }

        function showCouponModal(cell, shop) {
            const modal = document.getElementById('couponModal');
            const icon = document.getElementById('couponIcon');
            const shopName = document.getElementById('couponShopName');
            const category = document.getElementById('couponCategory');
            const discount = document.getElementById('couponDiscount');
            
            if (icon) icon.textContent = shop['ÂúñÁ§∫'] || cell.icon;
            if (shopName) shopName.textContent = shop['Â∫óÂÆ∂ÂêçÁ®±'];
            if (category) category.textContent = shop['ÂàÜÈ°û'];
            if (discount) discount.textContent = shop['ÂÑ™ÊÉ†ÂÖßÂÆπ'];
            
            if (modal) modal.classList.add('show');
        }

        async function saveCoupon() {
            if (gameState.currentCoupon) {
                const success = await issueCouponToAPI(gameState.currentCoupon);
                if (success) {
                    showStatusMessage('ÂÑ™ÊÉ†Âà∏Â∑≤ÂÑ≤Â≠òÂà∞ Google SheetsÔºÅ', 2000);
                } else {
                    showStatusMessage('ÂÑ≤Â≠òÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö', 2000);
                }
                closeCouponModal();
            }
        }

        function closeCouponModal() {
            const modal = document.getElementById('couponModal');
            if (modal) modal.classList.remove('show');
            gameState.currentCoupon = null;
        }

        async function issueCouponToAPI(shop) {
            const coupon = {
                couponId: 'CPN' + Date.now(),
                shopName: shop['Â∫óÂÆ∂ÂêçÁ®±'],
                discount: shop['ÂÑ™ÊÉ†ÂÖßÂÆπ'],
                category: shop['ÂàÜÈ°û'],
                shopId: shop['ID'],
                icon: shop['ÂúñÁ§∫'],
                createTime: Date.now(),
                expiryDate: formatDate(new Date(Date.now() + 30 * 24 * 60 * 60 * 1000))
            };
            
            const success = await saveCouponToSheet(coupon);
            
            if (success) {
                coupon.expiry = coupon.expiryDate;
                gameState.coupons.push(coupon);
                updateStats();
            }
            
            return success;
        }

        function showCellInfo(cell) {
            const modal = document.getElementById('modal');
            const content = document.getElementById('modalContent');
            
            if (!modal || !content) return;
            
            let html = `<div class="modal-icon">${cell.icon}</div>`;

            const cardStyles = {
                chance: { bg: 'linear-gradient(135deg, #fff3cd, #ffe69c)', color: '#856404', title: 'üéâ Ê©üÊúÉÂç°ÔºÅ', text: 'Áç≤Âæó 100 ÈáëÂπ£ + 2 ÂÄãÈ™∞Â≠ê' },
                fate: { bg: 'linear-gradient(135deg, #e7d9ff, #d4bbff)', color: '#6f42c1', title: '‚≠ê ÂëΩÈÅãÂç°ÔºÅ', text: 'Èö®Ê©ü‰∫ã‰ª∂Ëß∏Áôº‰∏≠...' },
                start: { bg: 'linear-gradient(135deg, #d4edda, #c3e6cb)', color: '#155724', title: 'üèÅ Ëµ∑ÈªûÔºÅ', text: 'Áç≤Âæó 100 ÈáëÂπ£' },
                jail: { bg: 'linear-gradient(135deg, #f8d7da, #f5c6cb)', color: '#721c24', title: 'üöì Áõ£ÁçÑÔºÅ', text: 'Âè™ÊòØÂèÉËßÄÔºå‰∏ãÊ¨°Â∞èÂøÉÔºÅ' },
                goback: { bg: 'linear-gradient(135deg, #fff3cd, #ffeaa7)', color: '#856404', title: '‚è™ ÂÄíÈÄÄ3Ê≠•ÔºÅ', text: 'ÂæÄÂõûËµ∞3Ê≠•' },
                gotojail: { bg: 'linear-gradient(135deg, #f8d7da, #f5c6cb)', color: '#721c24', title: 'üö® ÈÄ≤Áõ£ÁçÑÔºÅ', text: 'Áõ¥Êé•ÈÄÅÂæÄÁõ£ÁçÑÔºÅ' }
            };

            const style = cardStyles[cell.type];
            if (style) {
                html += `
                    <div class="modal-title">${cell.name}</div>
                    <div class="reward-card" style="background: ${style.bg};">
                        <div class="reward-title" style="color: ${style.color};">${style.title}</div>
                        <div class="reward-content">${style.text}</div>
                    </div>
                `;
            }

            html += `<button class="action-button close-button" onclick="closeModal()">ÈóúÈñâ</button>`;
            content.innerHTML = html;
            modal.classList.add('show');
        }

        function showCouponList() {
            const modal = document.getElementById('couponListModal');
            const content = document.getElementById('couponListContent');
            
            if (!modal || !content) return;
            
            let html = `<div class="coupon-list-title">ÊàëÁöÑÂÑ™ÊÉ†Âà∏</div>`;

            if (gameState.coupons.length === 0) {
                html += `
                    <div class="empty-coupons">
                        <div class="empty-coupons-icon">üé´</div>
                        <div class="empty-coupons-text">ÈÇÑÊ≤íÊúâÂÑ™ÊÉ†Âà∏</div>
                        <div class="empty-coupons-subtext">ÁπºÁ∫åÈÅäÊà≤Êî∂ÈõÜÊõ¥Â§öÂÑ™ÊÉ†ÂêßÔºÅ</div>
                    </div>
                `;
            } else {
                html += '<div class="coupon-list-items">';
                gameState.coupons.forEach(coupon => {
                    html += `
                        <div class="coupon-list-item">
                            <div class="coupon-list-info">
                                <h3>${coupon.icon} ${coupon.shopName}</h3>
                                <div class="coupon-list-category">${coupon.category}</div>
                                <div class="coupon-list-discount">${coupon.discount}</div>
                                <div class="coupon-list-expiry">ÊúâÊïàÊúüÈôê: ${coupon.expiry}</div>
                            </div>
                            <button class="use-coupon-button" onclick="useCoupon('${coupon.couponId}')">‰ΩøÁî®</button>
                        </div>
                    `;
                });
                html += '</div>';
            }

            html += `<button class="action-button close-button" onclick="closeCouponListModal()" style="margin-top: 20px; font-size: 22px; padding: 18px;">ÈóúÈñâ</button>`;
            content.innerHTML = html;
            modal.classList.add('show');
        }

        function closeCouponListModal() {
            const modal = document.getElementById('couponListModal');
            if (modal) modal.classList.remove('show');
        }

        function useCoupon(couponId) {
            const coupon = gameState.coupons.find(c => c.couponId === couponId);
            if (coupon) {
                alert(`Ë´ãÂà∞ ${coupon.shopName} Âá∫Á§∫Ê≠§ÂÑ™ÊÉ†Âà∏ÔºÅ\n\nÂÑ™ÊÉ†ÂÖßÂÆπÔºö${coupon.discount}\nÂÑ™ÊÉ†Âà∏IDÔºö${couponId}`);
            }
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            if (modal) modal.classList.remove('show');
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (event && event.target) {
                const navItem = event.target.closest('.nav-item');
                if (navItem) navItem.classList.add('active');
            }

            switch(tab) {
                case 'coupons':
                    showCouponList();
                    break;
                case 'map':
                    alert('Âú∞ÂúñÂäüËÉΩÈñãÁôº‰∏≠');
                    break;
                case 'profile':
                    if (confirm(`Áî®Êà∂Ë≥áÊñô\n\nÂêçÁ®±Ôºö${gameState.displayName}\nLINE IDÔºö${gameState.userId}\n\nË¶ÅÁôªÂá∫ÂóéÔºü`)) {
                        logout();
                    }
                    break;
            }
        }

        function updateStats() {
            const coinsEl = document.getElementById('coins');
            const diceCountEl = document.getElementById('diceCount');
            const remainingDiceEl = document.getElementById('remainingDice');
            const couponBadgeEl = document.getElementById('couponBadge');
            
            if (coinsEl) coinsEl.textContent = gameState.coins;
            if (diceCountEl) diceCountEl.textContent = gameState.diceCount;
            if (remainingDiceEl) remainingDiceEl.textContent = gameState.diceCount;
            if (couponBadgeEl) couponBadgeEl.textContent = gameState.coupons.length;
        }

        function showStatusMessage(msg, duration = 3000) {
            const statusMsg = document.getElementById('statusMessage');
            if (!statusMsg) return;
            
            statusMsg.textContent = msg;
            statusMsg.classList.add('show');
            
            if (duration > 0) {
                setTimeout(() => hideStatusMessage(), duration);
            }
        }

        function hideStatusMessage() {
            const statusMsg = document.getElementById('statusMessage');
            if (!statusMsg) return;
            
            statusMsg.classList.remove('show');
            setTimeout(() => {
                statusMsg.textContent = '';
            }, 300);
        }

        function toggleMusic() {
            const musicControl = document.getElementById('musicControl');
            const musicIcon = document.getElementById('musicIcon');
            
            if (!musicControl || !musicIcon) return;
            
            if (gameState.musicEnabled) {
                backgroundMusic.pause();
                musicControl.classList.add('muted');
                musicIcon.textContent = 'üîá';
                gameState.musicEnabled = false;
                gameState.soundEnabled = false;
            } else {
                backgroundMusic.play().catch(e => console.log('ËÉåÊôØÈü≥Ê®ÇÊí≠ÊîæÂ§±Êïó'));
                musicControl.classList.remove('muted');
                musicIcon.textContent = 'üéµ';
                gameState.musicEnabled = true;
                gameState.soundEnabled = true;
            }
        }

        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('couponListModal').addEventListener('click', function(e) {
            if (e.target === this) closeCouponListModal();
        });

        window.addEventListener('resize', updatePlayerPosition);
    </script>
</body>
</html>
