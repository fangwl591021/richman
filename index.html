<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
<title>æ­¡æ¨‚å¤§å¯Œç¿</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="common.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:"Microsoft JhengHei",sans-serif;
  background:#111;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:15px 0 75px;
  gap:15px;
}

/* éŠæˆ²æ¿ */
.board{
  width:95%;
  aspect-ratio:2/3;
  background:url("https://aiwe.cc/wp-content/uploads/2025/11/ece235adf24ce45191df6de0c0ba86e5.gif") center/contain no-repeat;
  background-color:#000;
  border-radius:10px;
  position:relative;
  overflow:hidden;
}

/* ç©å®¶ */
.player{
  position:absolute;
  width:80px;
  height:85px;
  transition:all .4s ease-in-out;
  z-index:10;
}
.player img{width:100%;height:100%;object-fit:contain;}
@keyframes walk{0%,100%{transform:rotate(0);}25%{transform:rotate(-4deg);}75%{transform:rotate(4deg);}}
.walking{animation:walk .45s infinite ease-in-out;}

/* ä¸­å¤®æ§åˆ¶å€ */
.center{
  position:absolute;
  top:65%;
  left:50%;
  transform:translate(-50%,-50%);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:15px;
  z-index:5;
}

.dice-box{
  display:flex;
  gap:25px;
}

.roll-btn{
  padding:15px 30px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:white;
  font-size:20px;
  font-weight:bold;
  border:none;
  border-radius:25px;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
  cursor:pointer;
  transition:all 0.3s ease;
}

.msg{
  color:#000;
  font-size:14px;
  font-weight:bold;
  text-shadow:1px 1px 2px rgba(255,255,255,.6);
  min-height:18px;
  transition:opacity .5s ease;
}

/* éª°å­æ¨£å¼ */
.dice{
  width:60px;
  height:60px;
  background:white;
  border-radius:12px;
  box-shadow:0 5px 15px rgba(0,0,0,.3);
  position:relative;
  display:flex;
  justify-content:center;
  align-items:center;
  border:2px solid #333;
}

.dot{
  width:10px;
  height:10px;
  background:black;
  border-radius:50%;
  position:absolute;
}

/* éª°å­é»æ•¸å¸ƒå±€ */
.face-1 .dot:nth-child(1){top:50%;left:50%;transform:translate(-50%,-50%);}
.face-2 .dot:nth-child(1){top:20%;left:20%;}
.face-2 .dot:nth-child(2){bottom:20%;right:20%;}
.face-3 .dot:nth-child(1){top:20%;left:20%;}
.face-3 .dot:nth-child(2){top:50%;left:50%;transform:translate(-50%,-50%);}
.face-3 .dot:nth-child(3){bottom:20%;right:20%;}
.face-4 .dot:nth-child(1){top:20%;left:20%;}
.face-4 .dot:nth-child(2){top:20%;right:20%;}
.face-4 .dot:nth-child(3){bottom:20%;left:20%;}
.face-4 .dot:nth-child(4){bottom:20%;right:20%;}
.face-5 .dot:nth-child(1){top:20%;left:20%;}
.face-5 .dot:nth-child(2){top:20%;right:20%;}
.face-5 .dot:nth-child(3){top:50%;left:50%;transform:translate(-50%,-50%);}
.face-5 .dot:nth-child(4){bottom:20%;left:20%;}
.face-5 .dot:nth-child(5){bottom:20%;right:20%;}
.face-6 .dot:nth-child(1){top:20%;left:20%;}
.face-6 .dot:nth-child(2){top:20%;right:20%;}
.face-6 .dot:nth-child(3){top:50%;left:20%;transform:translateY(-50%);}
.face-6 .dot:nth-child(4){top:50%;right:20%;transform:translateY(-50%);}
.face-6 .dot:nth-child(5){bottom:20%;left:20%;}
.face-6 .dot:nth-child(6){bottom:20%;right:20%;}

/* éª°å­å‹•ç•« */
.dice.rolling {animation:diceRoll 0.1s infinite;}
@keyframes diceRoll{
  0%{transform:rotate(0deg) scale(1);}
  25%{transform:rotate(90deg) scale(1.05);}
  50%{transform:rotate(180deg) scale(1.1);}
  75%{transform:rotate(270deg) scale(1.05);}
  100%{transform:rotate(360deg) scale(1);}
}

.dice.shake{animation:diceShake 0.5s ease-out;}
@keyframes diceShake{
  0%,100%{transform:translateY(0) scale(1);}
  10%,30%,50%,70%,90%{transform:translateY(-8px) scale(1.05);}
  20%,40%,60%,80%{transform:translateY(0) scale(1);}
}

.roll-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 15px rgba(0,0,0,.4);}
.roll-btn:active:not(:disabled){transform:translateY(0);}
.roll-btn:disabled{opacity:0.6;cursor:not-allowed;}

/* åº•éƒ¨åŠŸèƒ½å€ */
.bottom-bar{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:60px;
  background:#FFF8E1;
  display:flex;
  justify-content:space-around;
  align-items:center;
  z-index:100;
  border-top:2px solid rgba(0,0,0,0.1);
}

.bottom-bar button{
  flex:1;
  height:100%;
  border:none;
  background:transparent;
  color:#333;
  font-size:10px;
  font-weight:bold;
  cursor:pointer;
  transition:all .3s ease;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:2px;
}

.bottom-bar button:active{background:rgba(0,0,0,0.1);}
.bottom-bar button .icon{font-size:20px;color:#333;}
.bottom-bar button.logged-in{color:#5D4037;}

/* LINE é ­åƒ */
.line-avatar{
  width:30px;
  height:30px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #fff;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

#lineLoginBtn.has-avatar .icon{display:none;}
#lineLoginBtn .line-avatar{display:none;}
#lineLoginBtn.has-avatar .line-avatar{display:block;}

/* ç™»å…¥é é¢ */
.login-screen{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:999;padding:20px;
}
.login-screen.hidden{display:none;}
.login-box{
  background:white;border-radius:30px;
  padding:50px 40px;text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.3);
  max-width:450px;width:100%;
  animation:slideIn 0.5s ease;
}
@keyframes slideIn{
  from{opacity:0;transform:translateY(-30px);}
  to{opacity:1;transform:translateY(0);}
}
.login-box .logo{font-size:80px;margin-bottom:20px;animation:bounce 1s infinite ease-in-out;}
@keyframes bounce{
  0%,100%{transform:translateY(0);}
  50%{transform:translateY(-10px);}
}
.login-box h1{font-size:36px;color:#333;margin-bottom:15px;}
.login-box p{font-size:18px;color:#666;margin-bottom:40px;line-height:1.6;}
.login-box .line-login-btn{
  width:100%;padding:20px;
  background:#06C755;color:white;
  border:none;border-radius:15px;
  font-size:24px;font-weight:bold;
  cursor:pointer;transition:all 0.3s ease;
  display:flex;align-items:center;justify-content:center;
  gap:15px;box-shadow:0 8px 20px rgba(6,199,85,0.3);
}
.login-box .line-login-btn:hover{background:#05b04b;transform:translateY(-2px);box-shadow:0 12px 30px rgba(6,199,85,0.4);}
.login-box .line-login-btn .icon{font-size:32px;}

/* åº—å®¶å½ˆçª— */
.shop-popup{
  position:fixed;top:50%;left:50%;
  transform:translate(-50%,-50%);
  width:85%;max-width:300px;
  background:white;
  border-radius:12px;
  box-shadow:0 8px 25px rgba(0,0,0,.4);
  overflow:hidden;
  z-index:50;
  display:none;
  animation:fadeIn .4s ease;
}
@keyframes fadeIn{
  from{opacity:0;transform:translate(-50%,-45%);}
  to{opacity:1;transform:translate(-50%,-50%);}
}

.shop-hero{
  width:100%;
  height:0;
  padding-bottom:65%;
  position:relative;
  overflow:hidden;
}
.shop-hero img{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  object-fit:cover;
}

.shop-body{padding:16px;background:white;}
.shop-title{font-size:18px;font-weight:bold;color:#333;margin-bottom:8px;line-height:1.3;}
.shop-desc{font-size:13px;color:#666;line-height:1.5;}
.desc-line{margin-bottom:4px;display:block;}

.shop-footer{padding:0 16px 16px;background:white;}
.shop-buttons{display:flex;flex-direction:column;gap:8px;}
.shop-buttons button{
  width:100%;
  border:none;
  border-radius:8px;
  padding:12px;
  font-size:14px;
  font-weight:bold;
  cursor:pointer;
  color:white;
  transition:all 0.2s ease;
  text-align:center;
}
.shop-buttons button:active{transform:scale(0.98);}
.shop-buttons .claim{background:#764ba2;}
.shop-buttons .close{background:#888;}
</style>
</head>
<body>

<!-- ğŸ” LINE ç™»å…¥æ­¡è¿é é¢ -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="logo">ğŸ²</div>
    <h1>æ­¡æ¨‚å¤§å¯Œç¿</h1>
    <p>æ­¡è¿ä¾†åˆ°å¥½ç‰©å•†åœˆï¼<br>è«‹å…ˆä½¿ç”¨ LINE ç™»å…¥é–‹å§‹éŠæˆ²ï¼Œ<br>æ”¶é›†å°ˆå±¬å„ªæƒ åˆ¸å§ï¼</p>
    <button class="line-login-btn" onclick="startLineLogin()">
      <span class="icon">ğŸ“±</span>
      <span>ä½¿ç”¨ LINE ç™»å…¥</span>
    </button>
  </div>
</div>

<div class="board" id="board">
  <div class="player" id="player">
    <img src="https://aiwe.cc/wp-content/uploads/2025/11/897cb201ac922a1f9ed6e6f9082e84f5.png">
  </div>

  <div class="center">
  <div class="dice-box">
    <!-- éª°å­ 1 -->
    <div class="dice face-1" id="dice1">
      <div class="dot"></div>
    </div>
    
    <!-- éª°å­ 2 -->
    <div class="dice face-1" id="dice2">
      <div class="dot"></div>
    </div>
  </div>
  <button class="roll-btn" onclick="startGame()" id="rollBtn">ğŸ² æŠ•æ“²éª°å­</button>
  <div class="msg" id="msg"></div>
</div>

<!-- ğŸ§§ LINE Bubble é¢¨æ ¼åº—å®¶å„ªæƒ å¡ç‰‡ -->
<div class="shop-popup" id="shopPopup">
  <div class="shop-hero">
    <img id="shopImg" src="">
  </div>
  <div class="shop-body">
    <div class="shop-title" id="shopName"></div>
    <div class="shop-desc" id="shopDesc"></div>
  </div>
  <div class="shop-footer">
    <div class="shop-buttons">
      <button class="claim" id="claimBtn">æ”¶è—å„ªæƒ </button>
      <button class="close" onclick="closeShop()">æ”¾æ£„æ”¶è—</button>
    </div>
  </div>
</div>

<!-- ğŸ“± åº•éƒ¨åŠŸèƒ½åˆ— -->
<div class="bottom-bar">
  <button id="lineLoginBtn" onclick="lineLogin()">
    <span class="icon">ğŸ“±</span>
    <img class="line-avatar" id="lineAvatar" src="" alt="LINE">
    <span id="lineLoginText">LINE</span>
  </button>
  
  <button onclick="window.location.href='coupon.html'">
    <span class="icon">ğŸ«</span>
    <span>å„ªæƒ åˆ¸</span>
  </button>
  
  <button onclick="window.location.href='shop.html'">
    <span class="icon">ğŸ—ºï¸</span>
    <span>åº—å®¶åœ°åœ–</span>
  </button>
  
  <button onclick="switchToSVGVersion()">
    <span class="icon">ğŸ®</span>
    <span>SVGç‰ˆæœ¬</span>
  </button>
</div>

<!-- éŸ³æ•ˆ -->
<audio id="bgm" loop src="https://aiwe.cc/wp-content/uploads/2025/11/901cd11beb7b52aea3f9011f2d3d33bb.mp3"></audio>
<audio id="sDice" src="https://aiwe.cc/wp-content/uploads/2025/11/77b2287cce9574aeb82a8dbbcf200050.mp3"></audio>
<audio id="sMove" src="https://aiwe.cc/wp-content/uploads/2025/11/f8bf2fa137503315a28ad81a8aee77a5.mp3"></audio>

<script>
// ğŸ® éŠæˆ²æ ¸å¿ƒè®Šæ•¸èˆ‡è¨­å®š
const player = document.getElementById('player');
const board = document.getElementById('board');
const msg = document.getElementById('msg');
const dice1 = document.getElementById('dice1');
const dice2 = document.getElementById('dice2');
const rollBtn = document.getElementById('rollBtn');
const bgm = document.getElementById('bgm');
const sDice = document.getElementById('sDice');
const sMove = document.getElementById('sMove');
const shopPopup = document.getElementById('shopPopup');
const shopImg = document.getElementById('shopImg');
const shopName = document.getElementById('shopName');
const shopDesc = document.getElementById('shopDesc');
const claimBtn = document.getElementById('claimBtn');

let currentShop = null;
const rows = 9, cols = 6;
let pos = 0;

// éŠæˆ²è·¯å¾‘è¨­å®š
const path = [];
for (let x = cols - 1; x >= 0; x--) path.push({ x, y: rows - 1 });
for (let y = rows - 2; y >= 0; y--) path.push({ x: 0, y });
for (let x = 1; x < cols; x++) path.push({ x, y: 0 });
for (let y = 1; y < rows - 1; y++) path.push({ x: cols - 1, y });

// ============================================
// ğŸ® éŠæˆ²æ ¸å¿ƒåŠŸèƒ½
// ============================================
function startGame() {
  if (bgm.paused) {
    bgm.volume = 0.3;
    bgm.play().catch(() => {});
  }
  rollDice();
}

function updatePlayer() {
  const cell = path[pos];
  const w = board.clientWidth / cols;
  const h = board.clientHeight / rows;
  let offsetX = 0;
  
  if (cell.y === rows - 1) offsetX = -w * 0.05;
  else if (cell.y === 0) offsetX = w * 0.05;
  
  if (cell.x === cols - 1 && cell.y > 0 && cell.y < rows - 1) offsetX -= w * 0.27;
  
  player.style.left = `${cell.x * w + w / 2 - player.clientWidth / 2 + offsetX}px`;
  player.style.top = `${cell.y * h + h / 2 - player.clientHeight / 2}px`;
}

// âœ¨ æ›´æ–°éª°å­é¢
function updateDiceFace(el, v) {
  el.className = 'dice face-' + v;
  el.innerHTML = '';
  for (let i = 0; i < v; i++) {
    const dot = document.createElement('div');
    dot.className = 'dot';
    el.appendChild(dot);
  }
}

// âœ¨ ç©©å®šçš„éª°å­æŠ•æ“²å‡½æ•¸
async function rollDice() {
  rollBtn.disabled = true;
  rollBtn.textContent = 'ğŸ² æŠ•æ“²ä¸­...';
  
  // æ·»åŠ æ»¾å‹• class
  dice1.classList.add('rolling');
  dice2.classList.add('rolling');
  
  sDice.currentTime = 0;
  sDice.play();
  
  let count = 0, v1 = 1, v2 = 1;
  const interval = setInterval(() => {
    v1 = Math.floor(Math.random() * 6) + 1;
    v2 = Math.floor(Math.random() * 6) + 1;
    updateDiceFace(dice1, v1);
    updateDiceFace(dice2, v2);
    count++;
    
    if (count > 15) {
      clearInterval(interval);
      sDice.pause();
      
      // ç§»é™¤æ»¾å‹• class
      dice1.classList.remove('rolling');
      dice2.classList.remove('rolling');
      
      // æ·»åŠ éœ‡å‹•æ•ˆæœ
      dice1.classList.add('shake');
      dice2.classList.add('shake');
      
      // éœ‡å‹•çµæŸå¾Œç§»é™¤ class
      setTimeout(() => {
        dice1.classList.remove('shake');
        dice2.classList.remove('shake');
      }, 500);
      
      const total = v1 + v2;
      showMsg(`ğŸ² æ“²å‡º ${v1} + ${v2} = ${total} é»ï¼`);
      rollBtn.textContent = 'ğŸ² æŠ•æ“²éª°å­';
      movePlayer(total);
    }
  }, 80);
}

async function movePlayer(steps) {
  player.classList.add('walking');
  sMove.loop = true;
  sMove.currentTime = 0;
  sMove.play().catch(() => {});
  
  for (let i = 0; i < steps; i++) {
    pos = (pos + 1) % path.length;
    updatePlayer();
    await new Promise(r => setTimeout(r, 450));
  }
  
  player.classList.remove('walking');
  sMove.pause();
  sMove.currentTime = 0;
  
  await checkEvent();
  setTimeout(() => hideMsg(), 800);
  rollBtn.disabled = false;
}

// ============================================
// ğŸª åº—å®¶èˆ‡å„ªæƒ åŠŸèƒ½
// ============================================
async function checkEvent() {
  const cell = path[pos];
  
  if (cell.x === 0 && cell.y === 0) {
    showMsg("ğŸ’¥ è¸©åˆ°æ‡²ç½°æ ¼ï¼é€€å›7æ­¥ï¼");
    for (let i = 0; i < 7; i++) {
      pos = (pos - 1 + path.length) % path.length;
      updatePlayer();
      await new Promise(r => setTimeout(r, 300));
    }
    return;
  }
  
  try {
    const shops = await loadShops();
    console.log('ğŸ›ï¸ è¼‰å…¥åˆ°çš„åº—å®¶è³‡æ–™:', shops);
    
    if (shops && shops.length > 0) {
      const shop = shops[Math.floor(Math.random() * shops.length)];
      currentShop = shop;
      showShopPopup(shop);
    } else {
      console.log('âŒ æ²’æœ‰å¯ç”¨çš„åº—å®¶è³‡æ–™');
      showMsg('æš«ç„¡åº—å®¶è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  } catch (error) {
    console.error('âŒ è¼‰å…¥åº—å®¶æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    showMsg('è¼‰å…¥åº—å®¶å¤±æ•—');
  }
}

function showShopPopup(shop) {
  console.log('ğŸª é¡¯ç¤ºåº—å®¶å½ˆçª—:', shop);
  
  const imgUrl = shop["åœ–ç‰‡ç¶²å€"] || shop.icon || shop.imageUrl || "";
  const shopNameText = shop["åº—å®¶åç¨±"] || shop.name || shop.shopName || "ç¥ç§˜åº—å®¶";
  let shopDescText = shop["å„ªæƒ å…§å®¹"] || shop.discount || shop.description || "é™æ™‚å„ªæƒ ï¼Œè¶•å¿«ä¾†çœ‹çœ‹ï¼";
  
  // è™•ç†æ›è¡Œ - å°‡ \n è½‰æ›ç‚ºå¯¦éš›æ›è¡Œ
  shopDescText = shopDescText.replace(/\\n/g, '\n');
  
  if (imgUrl && (imgUrl.startsWith("http://") || imgUrl.startsWith("https://"))) {
    shopImg.src = imgUrl;
    shopImg.onerror = function() {
      this.src = "https://developers-resource.landpress.line.me/fx/img/01_1_cafe.png";
    };
  } else {
    shopImg.src = "https://developers-resource.landpress.line.me/fx/img/01_1_cafe.png";
  }
  
  shopName.textContent = shopNameText;
  
  // æ ¼å¼åŒ–å„ªæƒ å…§å®¹ï¼Œæ”¯æ´æ›è¡Œé¡¯ç¤º
  const formattedDesc = formatDescription(shopDescText);
  shopDesc.innerHTML = formattedDesc;
  
  shopPopup.style.display = 'block';
  claimBtn.disabled = false;
  claimBtn.textContent = "æ”¶è—å„ªæƒ ";
}

function closeShop() {
  shopPopup.style.display = 'none';
}

// ============================================
// æ”¶è—æŒ‰éˆ•äº‹ä»¶
// ============================================
claimBtn.addEventListener('click', async () => {
  if (!currentShop) return;
  
  claimBtn.disabled = true;
  claimBtn.textContent = "ğŸ‰ æ”¶è—ä¸­...";
  
  try {
    const success = await saveCoupon(currentShop);
    
    if (success) {
      claimBtn.textContent = "âœ… æ”¶è—æˆåŠŸï¼";
      setTimeout(() => {
        closeShop();
      }, 1500);
    } else {
      claimBtn.textContent = "âš ï¸ æ”¶è—å¤±æ•—";
      setTimeout(() => {
        claimBtn.textContent = "æ”¶è—å„ªæƒ ";
        claimBtn.disabled = false;
      }, 2000);
    }
    
  } catch (error) {
    console.error('âŒ æ”¶è—éŒ¯èª¤:', error);
    claimBtn.textContent = "âš ï¸ ç¶²è·¯éŒ¯èª¤";
    setTimeout(() => {
      claimBtn.textContent = "æ”¶è—å„ªæƒ ";
      claimBtn.disabled = false;
    }, 2000);
  }
});

function switchToSVGVersion() {
  if (confirm('è¦åˆ‡æ›åˆ° SVG ç‰ˆæœ¬éŠæˆ²å—ï¼Ÿ')) {
    window.location.href = 'game.html';
  }
}

// ============================================
// é é¢è¼‰å…¥åˆå§‹åŒ–
// ============================================
window.addEventListener('DOMContentLoaded', async function() {
  console.log('=== ğŸ“± åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ ===');
  console.log('ğŸ² ç©©å®š 2D éª°å­ç‰ˆæœ¬å·²å•Ÿç”¨ï¼');
  
  await initializeApp();
  updatePlayer();
});
</script>
</body>
</html>
